<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DBSCAN 交互演示（eps 与 min_samples 可独立交互）</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; margin: 0; }
  .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
  h1 { font-size: 20px; margin: 0 0 8px; }
  .sub { color: #555; margin-bottom: 14px; font-size: 14px; }
  .panel { display: grid; grid-template-columns: 1fr; gap: 14px; }
  #plot { width: 100%; height: 560px; }
  .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: center; }
  .ctrl { background: #f7f7f9; border: 1px solid #e3e3e7; border-radius: 10px; padding: 10px 12px; }
  .ctrl label { display: block; font-size: 13px; color: #333; margin-bottom: 6px; }
  .row { display: flex; gap: 12px; align-items: center; }
  input[type=range] { width: 100%; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #f0f0ff; border: 1px solid #d7d7ff; font-size: 12px; }
  .legend { font-size: 13px; color: #333; display: flex; gap: 12px; flex-wrap: wrap; }
  .dot { width:10px; height:10px; border-radius: 50%; display:inline-block; margin-right:6px; border:1px solid #3333; }
  .tri { width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-bottom:10px solid #555; display:inline-block; transform: translateY(2px); margin-right:6px; }
  .xmark { font-weight:700; margin-right:6px; }
  .stats { font-size: 13px; color: #333; }
</style>
</head>
<body>
<div class="wrap">
  <h1>DBSCAN：基于密度的视角（互动演示）</h1>
  <div class="sub">拖动 <b>ε (eps)</b> 与 <b>min_samples</b>，观察簇的形成/合并与噪声点变化。
    颜色代表簇（灰色为噪声）；形状表示点类型：<span class="dot" style="background:#999"></span>圆=核心，
    <span class="tri"></span>三角=边界，<span class="xmark">×</span>=噪声。</div>

  <div id="plot"></div>

  <div class="controls">
    <div class="ctrl">
      <label>ε (eps)：<span id="epsVal" class="badge"></span></label>
      <div class="row">
        <input id="eps" type="range" min="0.02" max="0.22" step="0.002">
      </div>
    </div>
    <div class="ctrl">
      <label>min_samples：<span id="msVal" class="badge"></span></label>
      <div class="row">
        <input id="ms" type="range" min="2" max="15" step="1">
      </div>
    </div>
  </div>

  <div class="stats" id="stats"></div>
</div>

<script>
// Data (embedded from Python)
const X = [[0.6533975917882665, 0.6059863249350441], [0.6502888280208029, 0.5959179291089428], [0.6481662725290008, 0.6002679560542867], [0.6537308795773216, 0.6368514735228088], [0.6473153669289017, 0.6165549669558831], [0.657949828514532, 0.6351824109471352], [0.65326437228877, 0.623796009182354], [0.6512941874264103, 0.6510007283795732], [0.6360818015171091, 0.641378912939973], [0.6292556803018121, 0.6360000355329032], [0.6292374686775786, 0.655603941840247], [0.6348925373234673, 0.667932850430743], [0.649960424439889, 0.6674674149612067], [0.6192323882126742, 0.668396872597041], [0.6458090999387869, 0.6826095587838888], [0.6282397280894896, 0.6803338194550168], [0.6332885675237487, 0.6814836608597099], [0.6548693553295463, 0.6870172386047811], [0.6414220790857595, 0.7149298801233213], [0.633957210170592, 0.7072035339810758], [0.6403173920918936, 0.7149764260471961], [0.623961265126662, 0.7205625848548846], [0.651272022715053, 0.7044499702485907], [0.6441088367235894, 0.7318991039933227], [0.625703428102871, 0.7621622148876783], [0.6396419643793952, 0.7250751294663134], [0.6301753870546523, 0.7538842959400234], [0.6253784578735297, 0.7605366435589707], [0.6248177249890914, 0.7655402709000869], [0.6396212022369905, 0.7529229720589827], [0.6237798403897966, 0.7608767586432152], [0.6208122991551576, 0.756388097534278], [0.6107426194289803, 0.774583180655155], [0.6249867483701805, 0.797381734299081], [0.5978763865631305, 0.7766626973584576], [0.6174884887211005, 0.7657344510280832], [0.6026639026014847, 0.7957442081678873], [0.6193595462560171, 0.8110230857623375], [0.5991210889471789, 0.8018149828927923], [0.5973593654738647, 0.8316491638055957], [0.5926938695343573, 0.8121552253405206], [0.5986639462122478, 0.8192469194292775], [0.5897287450800232, 0.8107044746155566], [0.5889441285010378, 0.8241566090079122], [0.5991701611796915, 0.843204148022178], [0.5829164559866223, 0.8478709387193769], [0.5763653579298301, 0.8573661711961673], [0.5770141044358678, 0.8555114066419475], [0.5595313851392736, 0.8566756604224981], [0.5519055380029065, 0.8293581750999534], [0.564100379730732, 0.8485888008200372], [0.5660301858477127, 0.8943839541325872], [0.5515683747633555, 0.860442631234254], [0.5597399714595236, 0.8792508751134385], [0.5520277295869099, 0.8739373381272213], [0.5583334349624909, 0.8874400564865876], [0.5354102910742508, 0.8833246074969596], [0.5437404186823408, 0.8741605370459693], [0.5426008592097458, 0.8804585503496412], [0.5468567684630851, 0.8980088655640089], [0.5332691878940831, 0.8911861293182379], [0.5271673104153044, 0.8760423077805036], [0.5120401953024523, 0.9107472449318941], [0.49704462860727144, 0.9205157486548738], [0.49740184885741273, 0.9226141328716733], [0.5034995142092062, 0.9261279690110525], [0.5104032513142018, 0.8985914466131134], [0.5188493254533318, 0.9411335154722812], [0.5001061313337117, 0.92140574739731], [0.49494891896162596, 0.9150455965462524], [0.5048473699422416, 0.9236305917126748], [0.4878374146002635, 0.9230960113730338], [0.47720776845486307, 0.9193856992571154], [0.49397265436492555, 0.9369066816535778], [0.48644246331746516, 0.9416815848988709], [0.4636021651308582, 0.9396564609534459], [0.46075520346046794, 0.9464932197364146], [0.45844508653331856, 0.9447387359765487], [0.4428464740543432, 0.9402686029344994], [0.47225572401463106, 0.9442332237893449], [0.43757841014342913, 0.9596850323274367], [0.46056020405274406, 0.9379583253255783], [0.43802131358049956, 0.9507777974515247], [0.4161648270921463, 0.9707379109164371], [0.43099836995097285, 0.9637133360557044], [0.4182877912437524, 0.9704776795651803], [0.41606656456756025, 0.9641615256958272], [0.4050997181318053, 0.9514626021356603], [0.4277325514515355, 0.9622951435950051], [0.41143016168769475, 0.9699219648521886], [0.3985817819894084, 0.9649114202164027], [0.4058486976578453, 0.9688308375745945], [0.3924267879360674, 0.974229914963657], [0.4025304359045414, 0.9839731045200423], [0.3889445156245284, 0.9684256716548246], [0.364515968727852, 0.989326357301387], [0.3859726925831701, 0.9756482157828721], [0.3764774232709048, 0.9885493327171129], [0.3749398360914762, 0.9910011875165287], [0.35580798047223894, 0.99937875000242], [0.34220295258319283, 0.9911504891726703], [0.35684128537770726, 0.9916500498285656], [0.3675094859709353, 1.0], [0.32897339908040546, 0.9581273528952278], [0.3460757188172122, 0.9671388469986046], [0.3320295719009412, 0.991714087872439], [0.309033608941194, 0.9525450245581942], [0.32547952931749224, 0.9809192592020367], [0.31505581618422557, 0.980585210427661], [0.303412782141182, 0.9596789378097995], [0.306376580560005, 0.9664303018978478], [0.2851243019424974, 0.9854931447464431], [0.2980124691349441, 0.9835817280389887], [0.28290066273167414, 0.968793340570503], [0.2780433664465432, 0.9649971430464476], [0.2866336053873143, 0.9655185863681135], [0.2836993958173049, 0.979458111638521], [0.29760974971748844, 0.9554810723131422], [0.280218332797811, 0.9716448606593109], [0.2654673689944529, 0.9524312392778712], [0.25581775581902466, 0.9802170255843369], [0.2553781907070805, 0.9700882314530381], [0.2484178329824492, 0.9828739327059977], [0.24680428473887592, 0.936899555110394], [0.23472308225807564, 0.9383653163004211], [0.20158654053416755, 0.9557427235723718], [0.24819359042663422, 0.9616244940290317], [0.21569608874509943, 0.9466882309725272], [0.23688757937095503, 0.9593126456052304], [0.22032319971716963, 0.9545071029308562], [0.21575819477058325, 0.9637986388030503], [0.21706467257168024, 0.953817364179423], [0.1948586894742161, 0.9554848624277285], [0.19448635792646002, 0.960881180165192], [0.18359424618130182, 0.942161556320756], [0.19338215456921706, 0.9239535256791245], [0.20839784679083873, 0.9582986770803601], [0.17976139544232203, 0.9465407936705599], [0.18494520320305566, 0.898977587367364], [0.17933383976391362, 0.9300110844696737], [0.17332407869190647, 0.9136977755744966], [0.16528231887236822, 0.9226732061546963], [0.17747541993456245, 0.9264620916477841], [0.16012431265421556, 0.9392132583925964], [0.1499983140337887, 0.9106464251070369], [0.1319697031523643, 0.9333779727093288], [0.15909234460904279, 0.9214464199603027], [0.15192711683219912, 0.9073990949224154], [0.14304204050052646, 0.8991732998188237], [0.13458374838284773, 0.8997367560307826], [0.14998856610463462, 0.9028178346502551], [0.12877457323409325, 0.8841495195858796], [0.11869589202167112, 0.9093682098493177], [0.12783751427290965, 0.8852687999053827], [0.11477050240474651, 0.8658563776643476], [0.11438602935143559, 0.8882418474600389], [0.10730017297750312, 0.8697075091285749], [0.10581253729784222, 0.8701619843304509], [0.08715282093372961, 0.8615219845195885], [0.09209642948028922, 0.8722335329696433], [0.08978575100430104, 0.8639720647004171], [0.1122029691594633, 0.8479270216361378], [0.08534114760259622, 0.850318081133906], [0.08894780875655134, 0.8302601495092076], [0.09108569666198471, 0.8657204323243896], [0.08009041225444419, 0.8318626447028137], [0.06839554150251165, 0.834261956412096], [0.06328350730386902, 0.8107990279483863], [0.08867820302401397, 0.8088499013190029], [0.08372477355964401, 0.8363766722323852], [0.0718708320695437, 0.8187948681366891], [0.08814050776363659, 0.8040919563522598], [0.057178233188661075, 0.78395824153078], [0.06176143179098129, 0.8166318674301748], [0.06956624016777657, 0.7796512687090841], [0.0469382154802122, 0.7805114300984891], [0.05743191478268343, 0.7794872119513309], [0.0543144656823867, 0.7811145573882816], [0.046402234686037706, 0.771586081522472], [0.04992052755372678, 0.7659029726355129], [0.05117776537875536, 0.7866645147855826], [0.05017397092796465, 0.7574387511309997], [0.022828412988344995, 0.7566285238803981], [0.01806204261282881, 0.7275735244500917], [0.04752881667629696, 0.7503232575422211], [0.03459378681297846, 0.712999173937852], [0.030465292163086185, 0.7213244074191587], [0.040125281789440276, 0.754864438149556], [0.03391768375127554, 0.7092278832778908], [0.016981728399242908, 0.7133880723710228], [0.026686100062290462, 0.6934259911044732], [0.028641700197422498, 0.6879621790346311], [0.03850685051561812, 0.7117971303505888], [0.03702515142142026, 0.6859195742277413], [0.029555643721754354, 0.6849141177310987], [0.018439366739328295, 0.676614550059237], [0.007309057841103384, 0.6564033900992888], [0.02978053167210784, 0.6674103810211492], [0.022507745135815264, 0.6776112356277466], [0.0, 0.6483291944113657], [0.020613978770875264, 0.6582816096541139], [0.013839175239491311, 0.6610788963399991], [0.019855439347015343, 0.6257107122442119], [0.00665411519061532, 0.646797143635983], [0.021820225322423774, 0.6052911729434578], [0.03135926374752472, 0.6327000763441993], [0.03105849897315065, 0.6140096431287907], [0.012588810057551567, 0.5984817210928398], [0.04408926994331561, 0.6053934783077677], [0.03345923261858275, 0.5934513535667431], [0.3363924065132902, 0.3905973614225175], [0.3303278752188588, 0.42008716044028094], [0.3207403944437534, 0.4155704213642381], [0.3386513947867963, 0.38184470073456106], [0.32954310310073026, 0.3839118389295126], [0.3349116144309763, 0.3772131224489367], [0.3266284818272139, 0.37461022594910487], [0.3248686747465018, 0.35589651397576166], [0.3363289571052603, 0.37902642936349706], [0.32041139845771427, 0.3617307979273802], [0.3309065398745521, 0.3431046466416499], [0.3484356848844078, 0.34356634431701194], [0.3564558145290718, 0.334493593159217], [0.3449447448573126, 0.3362246546191669], [0.33318381584920925, 0.3414491379214685], [0.3409045772688078, 0.3360991676166119], [0.34321274860247025, 0.30818292641763945], [0.34377794273483314, 0.3177420405147274], [0.3568582305204769, 0.2995509040382303], [0.34703972228198815, 0.2832722660290599], [0.35613307040378706, 0.28630974948132604], [0.3301601293955669, 0.2944323315975125], [0.3641766804018272, 0.26962222657594526], [0.34128771484351306, 0.2746046476610257], [0.34248291821293825, 0.2841413254379135], [0.34780271076000013, 0.2642449692892867], [0.3651130588393182, 0.25851696025536613], [0.3652922581806779, 0.25041175573317187], [0.34886216940979076, 0.23375177772108674], [0.3851474283617418, 0.2486517866367313], [0.36915691552312313, 0.24734370871356223], [0.3703408315657203, 0.24331064130759492], [0.3920343542432409, 0.2238221691594262], [0.35561106064244574, 0.21915466921301086], [0.3604091916230322, 0.2374762221258263], [0.38683247035142715, 0.20989933774730865], [0.36460030519236003, 0.21303638172354794], [0.39813823238491663, 0.1755229751792983], [0.3910521211175559, 0.19381836060423777], [0.39940593435147365, 0.1890257754945753], [0.38729308449702926, 0.17863355464923825], [0.38231358688916056, 0.21228588033922544], [0.405174422836038, 0.18398276599334512], [0.3891653417147185, 0.15964375627978647], [0.39739762222715447, 0.17981046753260743], [0.40382421475249075, 0.17451302939317156], [0.3952722357224446, 0.1704670227674455], [0.4104421176349698, 0.18408897522191459], [0.434842255528918, 0.16087342055524795], [0.4086533636289918, 0.15758345619579964], [0.41366981816540255, 0.144420647873392], [0.4230939879125911, 0.13630592886193113], [0.43386205979861686, 0.14468394185304542], [0.43328985099119044, 0.1396282670641117], [0.4258366213153281, 0.12554434186828142], [0.4348054603106374, 0.1269483282348774], [0.4436132916464587, 0.13033820481708605], [0.4293997961140494, 0.12752761433724455], [0.4332620601081315, 0.1147759296649382], [0.4486536401901711, 0.09181839251819415], [0.456696477064505, 0.11775397129380304], [0.4576938347133749, 0.10663611389190177], [0.4591138705381323, 0.09589193722301702], [0.46414186739315605, 0.09815037994465867], [0.47208510924708724, 0.08622854625441381], [0.47764273967124093, 0.10086196404230165], [0.4774263552012104, 0.0899967753561995], [0.4892009460053249, 0.07068382128541381], [0.49224564648377206, 0.0929557914936141], [0.4943773016568724, 0.09188322906235685], [0.48806562214375837, 0.08050895357230294], [0.5066481221686007, 0.08686947555589553], [0.5060607379620977, 0.05839047565804765], [0.5140047261496933, 0.09131779634249074], [0.5235505859292873, 0.07636452382495876], [0.49921556707977915, 0.08327433934467446], [0.5192982014906029, 0.03482712036988797], [0.5295245859558241, 0.046286767776453686], [0.5152518784763759, 0.055398213972703836], [0.5483498599167299, 0.05672995241026103], [0.5416312135914912, 0.08271572862345708], [0.560878412183929, 0.056177154586370036], [0.5449048159315046, 0.038911716331134036], [0.5443832787308205, 0.059406508885270555], [0.5611038818304112, 0.05346460082801617], [0.5723660998794092, 0.040085027185225816], [0.5652378613897159, 0.058404638524190866], [0.5769998647273717, 0.06138475475384799], [0.5795484803202688, 0.041656844839673905], [0.5838142184189492, 0.03111664260038677], [0.5661494155509971, 0.05082267759144361], [0.588514923060239, 0.04602652602038209], [0.5748873843357695, 0.035997453460602666], [0.5918522544331687, 0.02836354361053612], [0.5781098072850305, 0.034440646146626966], [0.6180238295151962, 0.04307377115123873], [0.6060538327722801, 0.0370609785907286], [0.6259622062348461, 0.0], [0.6208934471021901, 0.04317517796428555], [0.6346676035955984, 0.057999890567370475], [0.6445003431468516, 0.03917944148269359], [0.639988024477065, 0.045123055170797184], [0.6353876207022646, 0.033907043991622275], [0.6563083852858201, 0.06020457070282845], [0.6492104967433033, 0.03354164733652212], [0.6579947974914442, 0.0519803583670424], [0.6602335277472076, 0.05373744534040086], [0.6545752982564175, 0.03197455973208276], [0.6679380983768376, 0.04511723016900683], [0.6865967457971772, 0.015037907777421037], [0.669500274173655, 0.03992855677957331], [0.677134459833951, 0.01580567782354724], [0.700838496929131, 0.0431205302677079], [0.6995113348939542, 0.030958445043571748], [0.7102382456734686, 0.03484610237782402], [0.715729690575307, 0.02679817603568389], [0.6986908232336946, 0.042526105533645366], [0.7050993054547432, 0.04978490572392041], [0.7205397513252304, 0.02971077146538549], [0.7231371805865606, 0.03847437863432262], [0.7372145970155761, 0.03601968941461978], [0.7267488806748241, 0.06180526628631841], [0.761265937516631, 0.07368155664956558], [0.7416096138693933, 0.05161551111860717], [0.7626137027934892, 0.04867012026922136], [0.7391849075458116, 0.05355254570658969], [0.759673544486242, 0.042784320756928375], [0.7407980728438115, 0.03658159211058581], [0.7711019204385869, 0.04749812065060541], [0.7665831789063983, 0.062371607581818575], [0.7795271212581235, 0.057206190054990405], [0.7826142867420866, 0.05201812905077098], [0.777416029615256, 0.052484521549714336], [0.7984553988652756, 0.06802406822866935], [0.7819208071999877, 0.06611673801158345], [0.7920095555810294, 0.08254751113714902], [0.7809599098375722, 0.06207940290251035], [0.7987944538935903, 0.11200813437780698], [0.8178924683804963, 0.07968678915084365], [0.8193532749441056, 0.11120775026052977], [0.8129442602984878, 0.08194938575079087], [0.8331838414822449, 0.09628336192613561], [0.8312213718510233, 0.08600580801397441], [0.8492333048886962, 0.11846824473464752], [0.8380691007195782, 0.10803113576612329], [0.8130841339750322, 0.11063294193381364], [0.837450362060116, 0.11122170359031619], [0.8511002847962351, 0.10430894777761006], [0.8284469899021591, 0.117132628956196], [0.8428194856719284, 0.11137838644960303], [0.8480839510485709, 0.11478984595381389], [0.832749878514572, 0.1390687456526886], [0.8649933857070984, 0.1413642620475342], [0.8878569116051253, 0.1306962828447298], [0.8492017528694595, 0.12237541360663741], [0.8593484287646643, 0.13145495193161208], [0.8771564110427795, 0.11552330275953543], [0.8834906050893632, 0.12604864477401798], [0.8863374897610197, 0.14867892332984123], [0.8828179404829787, 0.15329005280939698], [0.8835401801775525, 0.15032924130008857], [0.8739784172480783, 0.1622959596103663], [0.9164878062693923, 0.19323056447832018], [0.9137273209615783, 0.18069699685674806], [0.8944569465822856, 0.19487216843379862], [0.9043511043996045, 0.17930733640881788], [0.9046426911686148, 0.18595512886375978], [0.9058934619085833, 0.18819474451775095], [0.9014465204611909, 0.18897252682802756], [0.9417378010192943, 0.19766958328937784], [0.916307790562254, 0.21036217246681402], [0.9294937852877869, 0.19331468126910314], [0.921840996740464, 0.22504929848482316], [0.9296630173550487, 0.21935331233561706], [0.946430406729878, 0.21365627006903642], [0.9323882699909768, 0.220688240452473], [0.9504073198451143, 0.20670101630708757], [0.928548674367199, 0.23057659945495376], [0.9456160947448939, 0.2506854266966364], [0.9559013311634498, 0.22689923171326135], [0.950763204059162, 0.2490092596985091], [0.9369521769585905, 0.2652206835731522], [0.9360371782336482, 0.23576354547445838], [0.9440324416853156, 0.24868209042636227], [0.9427148056434648, 0.27872810321153524], [0.9551626171543365, 0.3001402827930796], [0.9511110778273981, 0.26413642310372376], [0.9464919945983225, 0.27763928720690856], [0.9428616613414412, 0.30098555326423193], [0.9507045208326226, 0.2744392393633221], [0.9670658833027848, 0.3046107027215193], [0.9645865266734743, 0.31295974463834064], [0.9688992673112512, 0.31755738338777034], [0.9768216700773713, 0.32820096268902604], [0.9685087110644479, 0.33353737061819944], [0.9489158495154321, 0.33148104533076495], [0.963242208519313, 0.341986133810282], [0.9518697522574399, 0.36647840391469094], [0.969020131740615, 0.33438215871845495], [0.9495395905748029, 0.35232474351564036], [0.9682898865951226, 0.3521669691846426], [0.9709290558841212, 0.3588328184855312], [0.9765960942371984, 0.36338254286807853], [0.9704781867333602, 0.3916155886631371], [1.0, 0.370965773636229], [0.9664441601068855, 0.37886664902345124], [0.980631543722246, 0.38046473821099375], [0.9666547241879121, 0.4009712266426523], [0.9612467884379351, 0.39436791671929267], [0.9668962480036974, 0.3849119631921149]];

// Utility: Euclidean distance
function dist(a, b) { const dx=a[0]-b[0], dy=a[1]-b[1]; return Math.hypot(dx, dy); }

// DBSCAN (plain JS, recomputed every change)
function dbscan(points, eps, minSamples) {
  const n = points.length;
  const neighbors = new Array(n);
  for (let i=0;i<n;i++) {
    const nei = [];
    const pi = points[i];
    for (let j=0;j<n;j++) {
      if (dist(pi, points[j]) <= eps) nei.push(j);
    }
    neighbors[i] = nei;
  }
  const core = new Array(n).fill(false);
  for (let i=0;i<n;i++) core[i] = neighbors[i].length >= minSamples;

  const labels = new Array(n).fill(-1); // -1 noise
  const visited = new Array(n).fill(false);
  let clusterId = 0;

  for (let i=0;i<n;i++) {
    if (visited[i]) continue;
    visited[i] = true;
    if (!core[i]) continue;

    labels[i] = clusterId;
    const queue = [i];
    while (queue.length) {
      const p = queue.shift();
      const neis = neighbors[p];
      for (const q of neis) {
        if (labels[q] === -1) labels[q] = clusterId;
        if (!visited[q]) {
          visited[q] = true;
          if (core[q]) queue.push(q);
        }
      }
    }
    clusterId++;
  }

  // point types
  const ptype = new Array(n);
  for (let i=0;i<n;i++) {
    if (labels[i] === -1) ptype[i] = "noise";
    else ptype[i] = core[i] ? "core" : "border";
  }

  // stats
  const clusters = new Set(labels.filter(v => v !== -1));
  const nClusters = clusters.size;
  let coreCnt=0, borderCnt=0, noiseCnt=0;
  for (const t of ptype) {
    if (t==="core") coreCnt++;
    else if (t==="border") borderCnt++;
    else noiseCnt++;
  }
  return { labels, ptype, nClusters, coreCnt, borderCnt, noiseCnt };
}

// Palette
function palette(k) {
  const base = ["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd",
                "#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];
  const out = [];
  for (let i=0;i<k;i++) out.push(base[i % base.length]);
  return out;
}

// Render scatter with Plotly
const plotDiv = document.getElementById('plot');

function render(eps, ms) {
  const result = dbscan(X, eps, ms);
  const ids = [...new Set(result.labels.filter(v => v !== -1))].sort((a,b)=>a-b);
  const colors = palette(ids.length);
  const colorMap = new Map(ids.map((id, i) => [id, colors[i]]));

  const markerColors = result.labels.map(id => id === -1 ? "#BBBBBB" : colorMap.get(id));
  const symbols = result.ptype.map(t => t === "core" ? "circle" : (t === "border" ? "triangle-up" : "x"));
  const sizes = result.ptype.map(t => t === "core" ? 9 : (t === "border" ? 7 : 6));

  const trace = {
    x: X.map(p=>p[0]),
    y: X.map(p=>p[1]),
    mode: "markers",
    type: "scattergl",
    marker: {
      color: markerColors,
      size: sizes,
      symbol: symbols,
      opacity: 0.9,
      line: { width: 0.5, color: "#333" }
    },
    hovertemplate: "x=%{x:.3f}<br>y=%{y:.3f}}<extra></extra>",
    name: "points"
  };

  const layout = {
    title: "DBSCAN：密度视角（ε 与 min_samples 联动）" +
           "<br><span style='font-size:12px;color:#555'>颜色=簇（灰=噪声）；形状：圆=核心、三角=边界、×=噪声</span>",
    xaxis: { range: [-0.05, 1.05], zeroline: false },
    yaxis: { range: [-0.05, 1.05], scaleanchor: "x", scaleratio: 1, zeroline: false },
    margin: { l: 60, r: 30, t: 90, b: 40 }
  };

  Plotly.react(plotDiv, [trace], layout, {displayModeBar:false});

  // Update stats text
  const stats = document.getElementById('stats');
  stats.textContent = `ε = ${eps.toFixed(3)}，min_samples = ${ms} ｜ 簇数 = ${result.nClusters} ｜ 核心 = ${result.coreCnt} ｜ 边界 = ${result.borderCnt} ｜ 噪声 = ${result.noiseCnt}`;
}

// Init controls
const epsEl = document.getElementById('eps');
const msEl  = document.getElementById('ms');
const epsVal = document.getElementById('epsVal');
const msVal  = document.getElementById('msVal');

// defaults
let eps = 0.120, ms = 5;
epsEl.value = eps;
msEl.value = ms;
epsVal.textContent = eps.toFixed(3);
msVal.textContent  = ms;

epsEl.addEventListener('input', () => {
  eps = parseFloat(epsEl.value);
  epsVal.textContent = eps.toFixed(3);
  render(eps, ms);
});

msEl.addEventListener('input', () => {
  ms = parseInt(msEl.value, 10);
  msVal.textContent = ms;
  render(eps, ms);
});

// first render
render(eps, ms);
</script>
</body>
</html>
