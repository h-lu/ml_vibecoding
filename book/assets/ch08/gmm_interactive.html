<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>高斯混合模型 (GMM) 交互演示 — 软分配与 EM</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; margin: 0; }
  .wrap { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
  h1 { font-size: 20px; margin: 0 0 8px; }
  .sub { color:#555; margin-bottom: 14px; font-size: 14px; }
  .grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
  #plot { width: 100%; height: 560px; }
  .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; align-items: center; }
  .ctrl { background: #f7f7f9; border: 1px solid #e3e3e7; border-radius: 10px; padding: 10px 12px; }
  .ctrl label { display: block; font-size: 13px; color: #333; margin-bottom: 6px; }
  .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  input[type=range] { width: 100%; }
  select, button { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; background: white; cursor: pointer; }
  button:hover { background: #f3f3f3; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef; border: 1px solid #ccf; font-size: 12px; }
  .stats { font-size: 13px; color: #333; }
  .muted { color:#666; font-size:12px; }
</style>
</head>
<body>
<div class="wrap">
  <h1>GMM：基于概率的软分配（EM 算法）</h1>
  <div class="sub">
    拖动 <b>K</b> 与选择协方差形式（full/diag），点击 <b>步进</b> 或 <b>播放</b> 观察 EM 收敛。
    颜色=最可能簇（硬分配），<span class="muted">透明度≈最大后验概率（软分配置信度）。</span>
  </div>

  <div id="plot"></div>

  <div class="controls">
    <div class="ctrl">
      <label>簇个数 K：<span id="kVal" class="badge"></span></label>
      <div class="row">
        <input id="k" type="range" min="1" max="6" step="1">
        <button id="reinit">随机初始化</button>
      </div>
    </div>

    <div class="ctrl">
      <label>协方差类型：</label>
      <div class="row">
        <select id="covtype">
          <option value="full" selected>full（完整 2×2）</option>
          <option value="diag">diag（仅对角）</option>
        </select>
        <label><input type="checkbox" id="showContours" checked> 显示 1σ/2σ 等密度椭圆</label>
      </div>
    </div>

    <div class="ctrl">
      <label>EM 控制：</label>
      <div class="row">
        <button id="step">步进 (E→M)</button>
        <button id="play">播放</button>
        <button id="stop" disabled>停止</button>
      </div>
      <div class="muted" id="iterInfo"></div>
    </div>
  </div>

  <div id="stats" class="stats"></div>
</div>

<script>
const X = [[0.4877802672482252, 0.5655813402558685], [0.4252697824233584, 0.31236941349738745], [0.4563978474617755, 0.6284989247679157], [0.3496796655653598, 0.4084953580383965], [0.2261169608667224, 0.2405058369157681], [0.2764715078629789, 0.3632527410368701], [0.22061778178348385, 0.27707310567300414], [0.4684473664229111, 0.478458535746822], [0.16311988984602965, 0.5338414233309231], [0.2750685351770414, 0.44754042044712905], [0.4713897183202731, 0.48151757601243983], [0.4107878816644255, 0.48269799371400524], [0.21312525331785812, 0.05194164139932865], [0.18632731287273002, 0.2547162166807999], [0.26614662797204675, 0.22142808691421018], [0.3080981761759767, 0.33184304563134837], [0.2764886455819893, 0.2909449732785175], [0.24785544038766483, 0.2104103186174704], [0.23822550707469517, 0.25908520643781774], [0.45949417306379986, 0.39065155327706097], [0.224379814633271, 0.2657919196964174], [0.3645118418927108, 0.06870898685358888], [0.41554490627070106, 0.11401699199498257], [0.47599587377538016, 0.18815830339229422], [0.24969180584608647, 0.10746633732494408], [0.10881830862056374, 0.06579711482381491], [0.19537350591020436, 0.2383387015315591], [0.15640189474044142, 0.09733634271075141], [0.47934831502732517, 0.3793101381659645], [0.37724107269450974, 0.41589906749962563], [0.2925321867109916, 0.2532976879999236], [0.18680696415434284, 0.3675243519678998], [0.4889270033276534, 0.48400262681858613], [0.2904977618480838, 0.13428650484720758], [0.24636626650801816, 0.16536273372012855], [0.3661118482888711, 0.36497774688620493], [0.3128729870193091, 0.2697582947040918], [0.20183046719195474, 0.11278569298100741], [0.1304655246616414, 0.22399140634740186], [0.22702864921328875, 0.40093843300042004], [0.10587633856757127, 0.12640348836244777], [0.3467383748911142, 0.11631458888597283], [0.17726275371491612, 0.29364317938441825], [0.1773546696084103, 0.07020903355248438], [0.20101553017912138, 0.34125898321928594], [0.31457627038537755, 0.41733515445736175], [0.5035818820120436, 0.6743858865790681], [0.5491952576959563, 0.41030909258675313], [0.3636648154383778, 0.31819644303679956], [0.47448427030172535, 0.17936860832131216], [0.27115024719738173, 0.5241127757739015], [0.37601689260007004, 0.25380143783392], [0.2601636824082774, 0.2123327083403594], [0.26174524669606675, 0.19848890892014073], [0.13213873906491602, 0.09613215429265065], [0.3977237168774802, 0.1745462267030147], [0.3125994626685067, 0.46975516200388184], [0.3107635978383198, 0.45317692332663995], [0.45753306926568305, 0.5022989288501899], [0.22719734765019836, 0.2127558910133391], [0.27745140527300227, 0.3967065257817919], [0.12360192984954506, 0.12427296667158766], [0.10699151058776359, 0.1759932022826226], [0.3329025658126839, 0.38491240552783207], [0.2599475933255211, 0.07241965165518863], [0.4394688453745841, 0.4123492035780682], [0.5102827778154599, 0.5687995656859595], [0.23493745916656272, 0.22119027375620964], [0.5903181924438408, 0.3796123125609376], [0.23909117155331094, 0.3172956576338043], [0.2247581309142317, 0.15652791745884442], [0.4383213889586602, 0.5205472201953387], [0.49743553475174446, 0.32213552874759055], [0.32666979739219865, 0.08253910584269412], [0.30282447497741866, 0.14706757549848556], [0.2304441370208379, 0.29544047895377606], [0.2853092674860463, 0.202017459680451], [0.36336992107046284, 0.13391864559025354], [0.5496372429923947, 0.4981511259780498], [0.23125977526481842, 0.25850860786212454], [0.2609701173133063, 0.29344939706900447], [0.3503147404726087, 0.45663244726597346], [0.48532001729039437, 0.35834594460816127], [0.34494889323976063, 0.23691895719644246], [0.4446201691146209, 0.4681457937944376], [0.28219146424783814, 0.2283955964909846], [0.39319467877330483, 0.419566148109231], [0.2609363218585231, 0.11465619027784846], [0.3301838143382452, 0.22512771823432695], [0.29308195286454913, 0.38043007990209654], [0.3142242406358957, 0.3685706888848108], [0.3087148041666936, 0.3168498569919221], [0.15411417050486415, 0.3184422388551565], [0.48211838056710093, 0.42302796434155243], [0.07167899624317448, 0.42462376000864227], [0.13079464223042583, 0.3246969394450056], [0.43768817394293147, 0.4600269219697327], [0.041399808134066345, 0.17682283371624977], [0.2811999386422564, 0.31015342851063693], [0.20874492059433056, 0.3247507710154326], [0.22383693710497543, 0.23886928868854618], [0.0, 0.3499989091984655], [0.41643912184241366, 0.3897033211937951], [0.3468949940789032, 0.36471467722821593], [0.49327290983945926, 0.24908921959875707], [0.3037327608892391, 0.21435828712542698], [0.5392968708971441, 0.44924202501840554], [0.4952184019840058, 0.37555624274877075], [0.26315018808804075, 0.4193944306292571], [0.30038191093495464, 0.24460190962684328], [0.21792508765724747, 0.10167426471410569], [0.40096406300756526, 0.3193886018272874], [0.285047386255937, 0.3615740617683948], [0.4826174078876758, 0.4462213506685], [0.1916941380838617, 0.0], [0.29080152740379245, 0.26163210167313045], [0.3199067254923341, 0.2965699363001548], [0.34906842727748455, 0.39567433262809926], [0.22908735443921996, 0.3353459019977547], [0.1227416729091687, 0.009483931333562243], [0.6421548084914155, 0.7468324650245612], [0.6574508576161185, 0.4494596048503859], [0.6481197758098969, 0.42216258161338593], [0.720255285974747, 0.42267632024937474], [0.6620644137679087, 0.5765777116274273], [0.9900772082538357, 0.2992938489904252], [0.5350794542679073, 0.4701734739239476], [0.5374412848632624, 0.4537229702929928], [0.8101177439186766, 0.41259812000737645], [0.7141755592215444, 0.49766602004008065], [0.6356961325196824, 0.6695559947563025], [0.7569246460175125, 0.5299804883541017], [0.8631212668691549, 0.367066221893309], [0.8499879434549641, 0.5271582286615831], [0.8029038313820116, 0.4982465516173772], [0.7211740572323081, 0.3686904773608792], [0.70955311092972, 0.5690916051209729], [0.6462672096035053, 0.3168776058676672], [0.9177261888819395, 0.45182022706963637], [0.6895614673715205, 0.6100061258409399], [0.6782589010707603, 0.5553210779513316], [0.7844004806741702, 0.5763498349785139], [0.9146515355046357, 0.4544423569248403], [0.6255370376405093, 0.4856479654699994], [0.7425897168183941, 0.5369745050926806], [0.7175660959393563, 0.4435710362900486], [0.8395468985330381, 0.2869649558708483], [0.7412508018122684, 0.3963209763108081], [0.6270134759955343, 0.61165321396512], [0.953444285484282, 0.3381607068744322], [0.7088770168682305, 0.5300626970711982], [0.731466805929191, 0.5734944056763555], [0.7063448942974387, 0.614814192932945], [0.6824229899696438, 0.6147526093696172], [0.6659952836395837, 0.5205268040630214], [0.7171787639539029, 0.5414314864449576], [0.8625411904176956, 0.2701619987935322], [0.8724396543053944, 0.28638422616340276], [0.6687530544753543, 0.5822978911111044], [0.8329635529093622, 0.39578998938073207], [0.724454165246239, 0.4575245456961376], [0.8245694683974042, 0.38836627527374135], [0.6822284062017492, 0.5457566505183319], [0.7562744405627511, 0.6353992979287043], [0.692949089515748, 0.6300037459601534], [0.8953959233937941, 0.5076320872243838], [0.7538260699533166, 0.5055581152276483], [0.9773285970530995, 0.19564999901477392], [0.6783750978917763, 0.4559736519345759], [0.7603896657186211, 0.4108372020342398], [0.5470185858052454, 0.6201622402588656], [0.8709256611846579, 0.4037571265242842], [0.8952642828859949, 0.44968670662934346], [0.8689275607559536, 0.3911785694730912], [0.8420399357014658, 0.4072733021138128], [0.6173365785491527, 0.555027396761467], [0.6500445157789817, 0.7251194882680889], [0.7656507166657027, 0.49251231501960513], [0.9205662966577395, 0.5043051107324164], [0.5594433944637212, 0.7290132657735146], [0.5900714129028495, 0.6598598603302874], [0.8329394236521523, 0.5166685140849967], [0.9067250187784665, 0.2622815712855394], [0.6499341079875612, 0.371324329231115], [0.6965139172350476, 0.6017687956829719], [0.7628880658534352, 0.4528581147246512], [0.8257705546838492, 0.40815738823931436], [0.8318239062686038, 0.47550754421636166], [0.808256639625193, 0.5136438427934135], [0.9799343786586252, 0.1359826578892966], [0.9100891590315012, 0.6349536830681545], [1.0, 0.4616155188058798], [0.7567366728128895, 0.6070491769061203], [0.8266378712589664, 0.4549580809256118], [0.7041114886614456, 0.4665913048308562], [0.7903495742535193, 0.4413958325794321], [0.7047313494848048, 0.5655026735057678], [0.8619626610296753, 0.41086438888510785], [0.6686883668080524, 0.37685300098553165], [0.5958678882885138, 0.6607981536315263], [0.7274025317543471, 0.5729865997927198], [0.7220971858462921, 0.4215926066658801], [0.7079439579187891, 0.4718621442452863], [0.6183487976796609, 0.5317017948084783], [0.5496407419328574, 0.5121456856052559], [0.6758482007120525, 0.54367194568152], [0.6974535771621492, 0.6128193769094087], [0.7837748552012176, 0.5162970927463925], [0.8115066360848969, 0.6288115273988529], [0.7853637804580296, 0.4384968494973755], [0.7132053345256512, 0.6040188014675789], [0.793454301945266, 0.2877782768510836], [0.5777049730122612, 0.5926178056685345], [0.8040163126092637, 0.4137811647722977], [0.7853716885334627, 0.34363746889101204], [0.6371072614905073, 0.5329725189592555], [0.6708884351320203, 0.41632210838872974], [0.8115311315270638, 0.46671520209840406], [0.8776426679862739, 0.3292118664124483], [0.7950224804768846, 0.4996004340924327], [0.460310135461488, 0.7601570385946663], [0.4779065778111764, 0.869728406513419], [0.5234707739079976, 0.5761910143441197], [0.5627644427191373, 0.7183428178458271], [0.5557454129157349, 0.7325385369521581], [0.4880817041588253, 0.583974978040358], [0.4628028467400489, 0.7857800561789632], [0.3896630536537686, 0.8525426116836234], [0.4914101403321904, 0.781627737363435], [0.5527081115466297, 0.6946620291057262], [0.49614936723529945, 0.7284785193349923], [0.6571858583522987, 0.8980117843672067], [0.5059216322829654, 0.6603437618067693], [0.42354869114393917, 0.6431335346482872], [0.5251068559875012, 0.8158073125078176], [0.447869078132838, 0.8234197377082968], [0.5267075389262635, 0.8422326556125118], [0.47463962651885394, 0.6438730026588192], [0.5610040420274406, 0.9522765047423177], [0.5159550277121989, 0.8675087594547972], [0.6281812225251289, 0.6156368482360148], [0.5696756241216092, 0.8154385758924135], [0.5569402224366868, 0.7770342641502361], [0.37187580860894465, 0.8096881754704391], [0.6052133185391266, 0.9414210951589636], [0.5294236905619663, 0.682330740570528], [0.5263292183423609, 0.583383964963026], [0.6201128238488502, 0.7971469043415894], [0.505530628773681, 0.7592607607250048], [0.5263794615806366, 0.720508588121912], [0.5740107884163265, 0.7226331912788944], [0.5434106178421366, 0.7896839161521693], [0.6905001993707612, 0.7706426854369854], [0.6113261921444935, 0.6360985492027343], [0.8044442901853289, 0.6145586845816023], [0.523478610999577, 0.7104371653294449], [0.5723186473287867, 0.7825635016656408], [0.670027846739395, 0.6434739730949205], [0.5669219954467449, 0.7411477908189213], [0.457339762394395, 0.9668719968300937], [0.678356622005219, 0.8986593633282799], [0.48476253684045895, 0.8223956691348782], [0.6426774924003791, 1.0], [0.5302162119134411, 0.711231717659001], [0.5846767094447298, 0.8627498846866166], [0.508047439279106, 0.6933412558121923], [0.5891017570445378, 0.8972115267042607], [0.7562231384205413, 0.519495830939067], [0.5054802063455833, 0.7970811644202948], [0.5913131241515334, 0.7515076588735431], [0.5273535546044263, 0.6732945680183606], [0.6107313199403143, 0.8587656260315368], [0.5526118168425619, 0.6948863873297472], [0.5164551617259038, 0.8524654016851361], [0.635107275050899, 0.9784298892790447], [0.5032347714670021, 0.6825275836556229], [0.5520615225336589, 0.6698092031410138], [0.5384893668682467, 0.787401630612045], [0.5531846462104685, 0.7731892193715766], [0.7164329803372252, 0.6372228597145294], [0.561603967278872, 0.6999685279951361], [0.5956751123512225, 0.6226867300166874], [0.5329578210495753, 0.7175269001692592], [0.5161436584845742, 0.8484291868449104], [0.5997148502896417, 0.8875081115026628], [0.5709634910943259, 0.8502681228488427], [0.49659450812938655, 0.9175527904761114], [0.3999703080255045, 0.8649906486019306], [0.613229586507794, 0.9211088240728755], [0.5531630325089125, 0.6584036428247837], [0.5678149591669657, 0.8409931362365463], [0.5193932822955252, 0.7245301925201216], [0.5077967642105131, 0.8487616409585332], [0.587653595160307, 0.7763008547498333], [0.4966288435168037, 0.6832819260524302], [0.4496200149603443, 0.5173801780647234], [0.5638366227122429, 0.5216556415653235], [0.46601279121066214, 0.8929631601552451], [0.33099758993431144, 0.7001066023481057], [0.4684852730523583, 0.8025833378009349]];
const N = X.length;
const D = 2;

// Utilities
function randInt(n){ return Math.floor(Math.random()*n); }
function zeros(n){ return Array(n).fill(0); }
function zeros2(){ return [[0,0],[0,0]]; }
function copy2(A){ return [[A[0][0],A[0][1]],[A[1][0],A[1][1]]]; }
function add2(A,B){ return [[A[0][0]+B[0][0],A[0][1]+B[0][1]],[A[1][0]+B[1][0],A[1][1]+B[1][1]]]; }
function scale2(A,s){ return [[A[0][0]*s,A[0][1]*s],[A[1][0]*s,A[1][1]*s]]; }
function outer2(v){ return [[v[0]*v[0], v[0]*v[1]],[v[1]*v[0], v[1]*v[1]]]; }
function det2(A){ return A[0][0]*A[1][1]-A[0][1]*A[1][0]; }
function inv2(A){ const d=det2(A); const invd=1.0/(d+1e-12); return [[ A[1][1]*invd, -A[0][1]*invd],[-A[1][0]*invd, A[0][0]*invd]]; }
function addVec(a,b){ return [a[0]+b[0], a[1]+b[1]]; }
function subVec(a,b){ return [a[0]-b[0], a[1]-b[1]]; }
function scaleVec(a,s){ return [a[0]*s, a[1]*s]; }
function dot2(a,b){ return a[0]*b[0]+a[1]*b[1]; }

// Eigen-decomposition for symmetric 2x2
function eig2x2(A){
  const a=A[0][0], b=A[0][1], c=A[1][1];
  const tr=a+c, det=a*c-b*b, disc=Math.sqrt(Math.max(0, tr*tr-4*det));
  const l1=(tr+disc)/2, l2=(tr-disc)/2;
  function eigvec(l){
    if (Math.abs(b)>1e-12) { const v=[b, l-a]; const n=Math.hypot(v[0],v[1])||1; return [v[0]/n, v[1]/n]; }
    else { return a>=c ? [1,0] : [0,1]; }
  }
  const v1=eigvec(l1), v2=eigvec(l2);
  return {vals:[l1,l2], vecs:[v1,v2]};
}

// Multivariate normal log pdf for 2D
function logGauss2(x, mu, Sigma){
  const d = 2;
  const invS = inv2(Sigma);
  const detS = Math.max(det2(Sigma), 1e-18);
  const xm = subVec(x, mu);
  const quad = dot2(xm, [invS[0][0]*xm[0] + invS[0][1]*xm[1], invS[1][0]*xm[0] + invS[1][1]*xm[1]]);
  return -0.5*(d*Math.log(2*Math.PI) + Math.log(detS) + quad);
}

// Model state
let K = 3;
let covType = "full";
let params = null;  // {pi:[], mu:[K x 2], Sigma:[K x 2x2]}
let gamma = null;   // responsibilities [N x K]
let iter = 0;
let playing = false;
let timer = null;

// Initialization
function initParams(){
  const idxs = new Set();
  while (idxs.size < K) idxs.add(randInt(N));
  const seeds = Array.from(idxs);
  const mu = seeds.map(i => [X[i][0], X[i][1]]);
  // global variance
  let mean=[0,0];
  for (const p of X) mean=addVec(mean, p);
  mean=scaleVec(mean, 1/N);
  let S=zeros2();
  for (const p of X){ const d=subVec(p, mean); S=add2(S, outer2(d)); }
  S=scale2(S, 1/N);
  // Regularize
  const reg=1e-3;
  S[0][0]+=reg; S[1][1]+=reg;
  const Sigma = Array(K).fill(0).map(_=> copy2(S));
  const pi = Array(K).fill(1/K);
  gamma = Array(N).fill(0).map(_=> Array(K).fill(0));
  params = {pi, mu, Sigma};
  iter = 0;
}

// E-step
function estep(){
  for (let i=0;i<N;i++){
    const xi = X[i];
    let maxlog=-1e99, logs=[];
    for (let k=0;k<K;k++){
      const lg = Math.log(params.pi[k]+1e-18) + logGauss2(xi, params.mu[k], params.Sigma[k]);
      logs.push(lg); if (lg>maxlog) maxlog=lg;
    }
    // softmax
    let sumexp=0;
    for (let k=0;k<K;k++){ sumexp += Math.exp(logs[k]-maxlog); }
    for (let k=0;k<K;k++){ gamma[i][k] = Math.exp(logs[k]-maxlog)/sumexp; }
  }
}

// M-step
function mstep(){
  const Nk = Array(K).fill(0);
  for (let k=0;k<K;k++){
    for (let i=0;i<N;i++) Nk[k]+= gamma[i][k];
  }
  // weights
  for (let k=0;k<K;k++){ params.pi[k] = Math.max(Nk[k]/N, 1e-12); }
  // means
  for (let k=0;k<K;k++){
    let m=[0,0];
    for (let i=0;i<N;i++){ m=addVec(m, scaleVec(X[i], gamma[i][k])); }
    params.mu[k]= scaleVec(m, 1/Math.max(Nk[k],1e-12));
  }
  // covariances
  for (let k=0;k<K;k++){
    let S = zeros2();
    for (let i=0;i<N;i++){
      const d = subVec(X[i], params.mu[k]);
      const w = gamma[i][k];
      const o = outer2(d);
      S[0][0] += w*o[0][0]; S[0][1] += w*o[0][1];
      S[1][0] += w*o[1][0]; S[1][1] += w*o[1][1];
    }
    const invNk = 1/Math.max(Nk[k],1e-12);
    S = scale2(S, invNk);
    // regularize
    const reg=1e-6;
    if (covType==="diag"){
      S = [[Math.max(S[0][0], reg), 0],[0, Math.max(S[1][1], reg)]];
    } else {
      S[0][0]+=reg; S[1][1]+=reg;
    }
    params.Sigma[k]=S;
  }
}

// Log-likelihood
function loglik(){
  let L=0;
  for (let i=0;i<N;i++){
    const xi=X[i];
    let terms=0;
    for (let k=0;k<K;k++){
      const val = params.pi[k] * Math.exp(logGauss2(xi, params.mu[k], params.Sigma[k]));
      terms += val;
    }
    L += Math.log(terms + 1e-18);
  }
  return L;
}

// Information criteria
function numParams(){
  // weights: K-1 free + means: 2K + cov: full->3K, diag->2K
  const cov = (covType==="diag") ? 2*K : 3*K;
  return (K-1) + 2*K + cov;
}
function AIC(L){ return 2*numParams() - 2*L; }
function BIC(L){ return numParams()*Math.log(N) - 2*L; }

// Rendering
const plotDiv = document.getElementById("plot");
function palette(k){
  const base = ["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b"];
  const out = []; for (let i=0;i<k;i++) out.push(base[i%base.length]); return out;
}
function ellipseTrace(mu, Sigma, r, color){
  // r=1,2 for 1σ / 2σ; return closed polyline
  const eg = eig2x2(Sigma);
  const sqrtL = [Math.sqrt(Math.max(eg.vals[0],1e-12)), Math.sqrt(Math.max(eg.vals[1],1e-12))];
  const v1 = eg.vecs[0], v2 = eg.vecs[1];
  const ptsX=[], ptsY=[];
  for (let t=0;t<=64;t++){
    const ang = 2*Math.PI * t/64;
    const c = Math.cos(ang)*sqrtL[0]*r;
    const s = Math.sin(ang)*sqrtL[1]*r;
    const x = mu[0] + c*v1[0] + s*v2[0];
    const y = mu[1] + c*v1[1] + s*v2[1];
    ptsX.push(x); ptsY.push(y);
  }
  return {
    x: ptsX, y: ptsY, mode: "lines", type: "scatter",
    line: { color, width: (r===1?1.5:1), dash: (r===1?"solid":"dot") },
    hoverinfo: "skip", showlegend: false
  };
}

function render(){
  // responsibilities-based visuals
  const maxResp = new Array(N).fill(0);
  const hard = new Array(N).fill(0);
  for (let i=0;i<N;i++){
    let bestK=0, best=0;
    for (let k=0;k<K;k++){ const g=gamma[i][k]; if (g>best){best=g; bestK=k;} }
    hard[i]=bestK; maxResp[i]=best;
  }
  const cols = palette(K);
  const colors = hard.map(k=> cols[k]);
  const sizes = maxResp.map(g => 5 + 6*g); // size ~ confidence
  const opac  = maxResp.map(g => 0.35 + 0.65*g); // opacity ~ confidence

  const scatter = {
    x: X.map(p=>p[0]), y: X.map(p=>p[1]), type:"scattergl", mode:"markers",
    marker: { color: colors, size: sizes, opacity: opac, line: {width:0.5, color:"#333"} },
    hovertemplate: "x=%{x:.3f}<br>y=%{y:.3f}<br>max prob=%{customdata:.2f}<extra></extra>",
    customdata: maxResp
  };

  const traces = [scatter];
  if (document.getElementById("showContours").checked){
    for (let k=0;k<K;k++){
      traces.push( ellipseTrace(params.mu[k], params.Sigma[k], 1, cols[k]) );
      traces.push( ellipseTrace(params.mu[k], params.Sigma[k], 2, cols[k]) );
    }
  }

  const L = loglik();
  const kVal = document.getElementById("kVal");
  kVal.textContent = K;
  document.getElementById("iterInfo").textContent = `迭代次数：${iter}`;
  document.getElementById("stats").textContent =
    `log-likelihood = ${L.toFixed(3)} ｜ AIC = ${AIC(L).toFixed(2)} ｜ BIC = ${BIC(L).toFixed(2)} ｜ 协方差=${covType}`;

  const layout = {
    title: "GMM 软分配可视化（颜色=硬分配，透明度/尺寸≈置信度；椭圆=1σ/2σ）",
    xaxis: { range:[-0.05,1.05], zeroline:false },
    yaxis: { range:[-0.05,1.05], scaleanchor:"x", scaleratio:1, zeroline:false },
    margin: { l:60, r:20, t:70, b:40 }
  };

  Plotly.react(plotDiv, traces, layout, {displayModeBar:false});
}

// One EM step (E then M)
function stepEM(){ estep(); mstep(); iter++; render(); }

// Handlers
const kEl = document.getElementById("k");
const covEl = document.getElementById("covtype");
const reinitBtn = document.getElementById("reinit");
const stepBtn = document.getElementById("step");
const playBtn = document.getElementById("play");
const stopBtn = document.getElementById("stop");
const showContours = document.getElementById("showContours");

function resetModel(){
  K = parseInt(kEl.value,10);
  covType = covEl.value;
  initParams();
  render();
}

kEl.value = 3;
document.getElementById("kVal").textContent = "3";
covEl.value = "full";

kEl.addEventListener("input", ()=>{
  document.getElementById("kVal").textContent = kEl.value;
  resetModel();
});
covEl.addEventListener("change", resetModel);
reinitBtn.addEventListener("click", resetModel);
showContours.addEventListener("change", render);

stepBtn.addEventListener("click", stepEM);
playBtn.addEventListener("click", ()=>{
  if (playing) return;
  playing = true; playBtn.disabled = true; stopBtn.disabled = false;
  timer = setInterval(()=>{
    for (let i=0;i<2;i++) stepEM(); // 2 steps per tick for speed
    if (iter>=60) { clearInterval(timer); playing=false; playBtn.disabled=false; stopBtn.disabled=true; }
  }, 200);
});
stopBtn.addEventListener("click", ()=>{
  if (timer) clearInterval(timer);
  playing=false; playBtn.disabled=false; stopBtn.disabled=true;
});

// init
initParams(); render();

</script>
</body>
</html>
