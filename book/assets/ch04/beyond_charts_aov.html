<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AOV 结构性变化：分布与占比联动</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; margin: 0; }
    .wrap { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    .sub { color:#555; margin-bottom: 14px; font-size: 14px; }
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: center; }
    .ctrl { background: #f7f7f9; border: 1px solid #e3e3e7; border-radius: 10px; padding: 10px 12px; }
    .ctrl label { display: block; font-size: 13px; color: #333; margin-bottom: 6px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    input[type=range] { width: 240px; }
    select { padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef; border: 1px solid #ccf; font-size: 12px; }
    .row2 { display: grid; grid-template-columns: 2fr 1fr; gap: 14px; }
    #dist, #mix { width: 100%; height: 620px; }
    .stats { font-size: 13px; color: #333; }
    @media (max-width: 900px) { .row2 { grid-template-columns: 1fr; } #dist, #mix { height: 520px; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>AOV 结构性变化：分布与占比联动</h1>
    <div class="sub">通过“品类占比变化”来模拟 AOV 下降的结构性原因。左侧展示各品类 AOV 分布（箱线/小提琴，支持叠加原始点），右侧展示两期的品类订单占比。下方统计展示两期整体 AOV 的变化与差值。</div>

    <div class="controls">
      <div class="ctrl">
        <label>总样本量/期：<span id="nBadge" class="badge"></span></label>
        <div class="row"><input id="n" type="range" min="200" max="5000" step="100"></div>
      </div>
      <div class="ctrl">
        <label>结构变化：低客单品类占比↑（-40% ~ +40%）<span id="mixBadge" class="badge"></span></label>
        <div class="row"><input id="mixShift" type="range" min="-40" max="40" step="5"></div>
      </div>
      <div class="ctrl">
        <label>分布图类型</label>
        <div class="row">
          <select id="distType">
            <option value="box">箱线图（Box）</option>
            <option value="violin">小提琴图（Violin）</option>
          </select>
          <label><input id="showPoints" type="checkbox"> 叠加原始点</label>
          <label><input id="showMedian" type="checkbox" checked> 显示中位数</label>
        </div>
      </div>
      <div class="ctrl">
        <label>当前统计</label>
        <div class="row"><div id="stats" class="stats"></div></div>
      </div>
    </div>

    <div class="row2">
      <div id="dist"></div>
      <div id="mix"></div>
    </div>
  </div>

  <script>
    function applyScaleFromQuery() {
      const s = parseFloat(new URLSearchParams(location.search).get('scale'));
      if (Number.isFinite(s) && s > 0 && s !== 1) {
        const b = document.body;
        b.style.transform = `scale(${s})`;
        b.style.transformOrigin = 'top left';
        b.style.width = `${100 / s}%`;
        b.style.minWidth = `${100 / s}%`;
      }
    }

    const UI = {
      n: document.getElementById('n'), nBadge: document.getElementById('nBadge'),
      mixShift: document.getElementById('mixShift'), mixBadge: document.getElementById('mixBadge'),
      distType: document.getElementById('distType'),
      showPoints: document.getElementById('showPoints'),
      showMedian: document.getElementById('showMedian'),
      stats: document.getElementById('stats')
    };

    const state = { n: 1500, mixShift: 20, distType: 'box', showPoints: false, showMedian: true };

    const cats = [
      { name:'电子产品', mu: 250, sigma: 60, key:'elec' },
      { name:'家居用品', mu: 180, sigma: 40, key:'home' },
      { name:'服装配饰', mu: 120, sigma: 35, key:'app' },
      { name:'食品饮料', mu: 90,  sigma: 25, key:'food' },
      { name:'图书文娱', mu: 70,  sigma: 20, key:'book' }
    ];
    const baseShare = { elec:0.25, home:0.20, app:0.20, food:0.20, book:0.15 };

    function randn(){ let u=0,v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random(); return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v); }
    function truncNorm(mu, sigma, minv=10){ let x; let tries=0; do{ x = mu + sigma*randn(); tries++; if (tries>100) break; } while(x<minv); return Math.max(minv, x); }

    function adjustedShares(shiftPct){
      // 正向：降低高客单（电子）占比，提高低客单（服装/食品/图书）；负向则相反
      const s = shiftPct/100;
      const w = {
        elec: 1 - 0.8*s,
        home: 1 + 0.2*s,
        app:  1 + 0.5*s,
        food: 1 + 0.5*s,
        book: 1 + 0.3*s
      };
      const out = {};
      let Z = 0;
      for (const c of cats){ Z += baseShare[c.key]*w[c.key]; }
      for (const c of cats){ out[c.key] = (baseShare[c.key]*w[c.key]) / Z; }
      return out;
    }

    function simulatePeriod(shares, n){
      const values = []; const labels = [];
      const counts = {};
      for (const c of cats) counts[c.key] = 0;
      // 多项分配到各类
      const keys = cats.map(c=>c.key);
      const probs = keys.map(k=>shares[k]);
      for (let i=0;i<n;i++){
        let r = Math.random(); let acc=0; let chosen = keys[keys.length-1];
        for (let j=0;j<keys.length;j++){ acc+=probs[j]; if (r<=acc){ chosen=keys[j]; break; } }
        counts[chosen] += 1;
      }
      // 按类别生成 AOV
      for (const c of cats){
        const k=c.key; const cnt=counts[k];
        for (let i=0;i<cnt;i++) { values.push(truncNorm(c.mu, c.sigma)); labels.push(c.name); }
      }
      return { values, labels, counts };
    }

    function mean(a){ return a.reduce((s,v)=>s+v,0)/Math.max(1,a.length); }
    function median(a){ const b=[...a].sort((x,y)=>x-y); const n=b.length; return n? (n%2? b[(n-1)/2] : (b[n/2-1]+b[n/2])/2) : NaN; }

    function draw(){
      UI.nBadge.textContent = state.n;
      UI.mixBadge.textContent = `${state.mixShift}%`;

      const shareBase = baseShare;
      const shareShifted = adjustedShares(state.mixShift);
      const p0 = simulatePeriod(shareBase, state.n);
      const p1 = simulatePeriod(shareShifted, state.n);

      // 左：分布（两期分组并列）
      const tracesDist = [];
      const palette = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd'];
      if (state.distType==='box'){
        // 两期分开：在每个类别下放两个 box
        for (let idx=0; idx<cats.length; idx++){
          const name=cats[idx].name;
          const v0 = p0.values.filter((_,i)=>p0.labels[i]===name);
          const v1 = p1.values.filter((_,i)=>p1.labels[i]===name);
          tracesDist.push({ type:'box', name:`${name}·上期`, x:v0.map(()=>name), y:v0, marker:{color:palette[idx]}, boxmean: state.showMedian? 'sd':false, legendgroup:`${name}-0`, offsetgroup:`${name}-0` });
          tracesDist.push({ type:'box', name:`${name}·本期`, x:v1.map(()=>name), y:v1, marker:{color:palette[idx], opacity:0.55}, boxmean: state.showMedian? 'sd':false, legendgroup:`${name}-1`, offsetgroup:`${name}-1` });
          if (state.showPoints){
            const jx0 = v0.map(()=>name), jy0=v0; const jx1=v1.map(()=>name), jy1=v1;
            tracesDist.push({ type:'scattergl', mode:'markers', name:`点·上期`, showlegend:false, x:jx0, y:jy0, marker:{ size:4, color:palette[idx], opacity:0.35 }, offsetgroup:`${name}-0` });
            tracesDist.push({ type:'scattergl', mode:'markers', name:`点·本期`, showlegend:false, x:jx1, y:jy1, marker:{ size:4, color:palette[idx], opacity:0.18 }, offsetgroup:`${name}-1` });
          }
        }
      } else {
        for (let idx=0; idx<cats.length; idx++){
          const name=cats[idx].name;
          const v0 = p0.values.filter((_,i)=>p0.labels[i]===name);
          const v1 = p1.values.filter((_,i)=>p1.labels[i]===name);
          tracesDist.push({ type:'violin', name:`${name}·上期`, x:v0.map(()=>name), y:v0, marker:{color:palette[idx]}, points: state.showPoints? 'all':'none', pointpos:0, side:'positive', legendgroup:`${name}-0`, offsetgroup:`${name}-0` });
          tracesDist.push({ type:'violin', name:`${name}·本期`, x:v1.map(()=>name), y:v1, marker:{color:palette[idx], opacity:0.55}, points: state.showPoints? 'all':'none', pointpos:0, side:'negative', legendgroup:`${name}-1`, offsetgroup:`${name}-1` });
        }
      }
      const layoutDist = {
        title: '各品类 AOV 分布（上期 vs 本期）',
        xaxis: { title: '品类' },
        yaxis: { title: '客单价（示例单位）', rangemode:'tozero' },
        boxmode: 'group', violinmode:'overlay',
        margin: { l: 60, r: 20, t: 40, b: 40 }
      };
      Plotly.react('dist', tracesDist, layoutDist, {displayModeBar:false});

      // 右：占比堆叠条形（上期、本期）
      const catsNames = cats.map(c=>c.name);
      function toArrayCounts(counts){ return cats.map(c=>counts[c.key]); }
      const c0 = toArrayCounts(p0.counts);
      const c1 = toArrayCounts(p1.counts);
      const total0 = c0.reduce((s,v)=>s+v,0), total1 = c1.reduce((s,v)=>s+v,0);
      const shareFrac0 = c0.map(v=>v/Math.max(1,total0));
      const shareFrac1 = c1.map(v=>v/Math.max(1,total1));
      const tracesMix = [];
      for (let i=0;i<cats.length;i++){
        tracesMix.push({ x:['上期','本期'], y:[shareFrac0[i], shareFrac1[i]], name: catsNames[i], type:'bar', marker:{ color: palette[i] } });
      }
      const layoutMix = {
        title: '订单结构占比（上期 vs 本期）',
        barmode:'stack',
        yaxis:{ title:'占比', tickformat:'.0%', rangemode:'tozero' },
        margin: { l: 60, r: 20, t: 40, b: 40 }
      };
      Plotly.react('mix', tracesMix, layoutMix, {displayModeBar:false});

      // 统计：整体 AOV 变化
      const aov0 = mean(p0.values), aov1 = mean(p1.values);
      const med0 = median(p0.values), med1 = median(p1.values);
      const diff = aov1 - aov0; const diffPct = aov0 ? diff / aov0 : NaN;
      UI.stats.textContent = `上期 AOV（均值/中位）≈ ${aov0.toFixed(1)} / ${med0.toFixed(1)} ｜ 本期 AOV（均值/中位）≈ ${aov1.toFixed(1)} / ${med1.toFixed(1)} ｜ 变化 Δ=${diff.toFixed(1)}（${isFinite(diffPct)?(diffPct*100).toFixed(1)+'%':'—'}）`;
    }

    function init(){
      applyScaleFromQuery();
      UI.n.value = state.n; UI.mixShift.value = state.mixShift; UI.distType.value = state.distType;
      UI.showPoints.checked = state.showPoints; UI.showMedian.checked = state.showMedian;
      UI.nBadge.textContent = state.n; UI.mixBadge.textContent = `${state.mixShift}%`;
      UI.n.addEventListener('input', ()=>{ state.n = parseInt(UI.n.value,10)||1000; draw(); });
      UI.mixShift.addEventListener('input', ()=>{ state.mixShift = parseInt(UI.mixShift.value,10)||0; UI.mixBadge.textContent = `${state.mixShift}%`; draw(); });
      UI.distType.addEventListener('change', ()=>{ state.distType = UI.distType.value; draw(); });
      UI.showPoints.addEventListener('change', ()=>{ state.showPoints = UI.showPoints.checked; draw(); });
      UI.showMedian.addEventListener('change', ()=>{ state.showMedian = UI.showMedian.checked; draw(); });
      draw();
      window.addEventListener('resize', ()=>{ 
        const d = document.getElementById('dist');
        const m = document.getElementById('mix');
        if (d) Plotly.Plots.resize(d);
        if (m) Plotly.Plots.resize(m);
      });
    }

    init();
  </script>
</body>
</html>


