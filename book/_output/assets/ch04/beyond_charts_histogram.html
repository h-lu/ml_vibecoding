<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>直方图：分布形状、偏态与多峰</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; margin: 0; }
    .wrap { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    .sub { color:#555; margin-bottom: 14px; font-size: 14px; }
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: center; }
    .ctrl { background: #f7f7f9; border: 1px solid #e3e3e7; border-radius: 10px; padding: 10px 12px; }
    .ctrl label { display: block; font-size: 13px; color: #333; margin-bottom: 6px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    input[type=range] { width: 220px; }
    select { padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef; border: 1px solid #ccf; font-size: 12px; }
    #plot { width: 100%; height: 520px; }
    .stats { font-size: 13px; color: #333; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>直方图：分布形状、偏态与多峰</h1>
    <div class="sub">切换分布形状并调整样本量与分箱数；可叠加核密度曲线（KDE）与 rug 标记，直观看到分布的对称性、偏态与多峰特征。</div>

    <div class="controls">
      <div class="ctrl">
        <label>分布形状</label>
        <div class="row">
          <select id="dist">
            <option value="normal">正态分布</option>
            <option value="lognormal">偏态分布（对数正态）</option>
            <option value="bimodal">双峰分布（两正态混合）</option>
          </select>
        </div>
      </div>
      <div class="ctrl">
        <label>样本量 N：<span id="nBadge" class="badge"></span></label>
        <div class="row"><input id="n" type="range" min="100" max="3000" step="100"></div>
      </div>
      <div class="ctrl">
        <label>分箱数 bins：<span id="binsBadge" class="badge"></span></label>
        <div class="row"><input id="bins" type="range" min="8" max="60" step="1"></div>
      </div>
      <div class="ctrl">
        <label>叠加选项</label>
        <div class="row">
          <label><input id="showKDE" type="checkbox" checked> KDE</label>
          <label><input id="showRug" type="checkbox"> rug</label>
        </div>
      </div>
      <div class="ctrl">
        <label>当前统计</label>
        <div class="row"><div id="stats" class="stats"></div></div>
      </div>
    </div>

    <div id="plot"></div>
  </div>

  <script>
    function applyScaleFromQuery() {
      const s = parseFloat(new URLSearchParams(location.search).get('scale'));
      if (Number.isFinite(s) && s > 0 && s !== 1) {
        const b = document.body;
        b.style.transform = `scale(${s})`;
        b.style.transformOrigin = 'top left';
        b.style.width = `${100 / s}%`;
        b.style.minWidth = `${100 / s}%`;
      }
    }
    const UI = {
      dist: document.getElementById('dist'),
      n: document.getElementById('n'), nBadge: document.getElementById('nBadge'),
      bins: document.getElementById('bins'), binsBadge: document.getElementById('binsBadge'),
      showKDE: document.getElementById('showKDE'),
      showRug: document.getElementById('showRug'),
      stats: document.getElementById('stats')
    };

    const state = { dist: 'normal', n: 800, bins: 30, showKDE: true, showRug: false };

    function randn() { let u=0, v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random(); return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v); }

    function sample() {
      const n = state.n; const out = new Array(n);
      if (state.dist === 'normal') {
        for (let i=0;i<n;i++) out[i] = randn();
      } else if (state.dist === 'lognormal') {
        const mu = 0, sigma = 0.8; // 偏态更明显
        for (let i=0;i<n;i++) out[i] = Math.exp(mu + sigma*randn());
      } else {
        for (let i=0;i<n;i++) {
          const z = Math.random() < 0.5 ? (-2 + randn()) : (2 + randn());
          out[i] = z;
        }
      }
      // 线性缩放至 [0, 100]
      const min = Math.min(...out), max = Math.max(...out);
      const a = 100/((max-min)||1), b = -a*min;
      return out.map(v=>a*v+b);
    }

    function mean(a){ return a.reduce((s,v)=>s+v,0)/a.length; }
    function std(a){ const m=mean(a); return Math.sqrt(a.reduce((s,v)=>s+(v-m)*(v-m),0)/Math.max(1,a.length-1)); }
    function median(a){ const b=[...a].sort((x,y)=>x-y); const n=b.length; return n%2?b[(n-1)/2]:(b[n/2-1]+b[n/2])/2; }
    function skewness(a){ const m=mean(a), s=std(a)||1; const n=a.length; return a.reduce((acc,v)=>acc+Math.pow((v-m)/s,3),0)/n; }

    function kde(x, xs) {
      const n = xs.length; const s = std(xs) || 1; const h = 1.06*s*Math.pow(n, -1/5); const inv = 1/(Math.sqrt(2*Math.PI)*h*n);
      return inv * xs.reduce((acc,xi)=> acc + Math.exp(-0.5*Math.pow((x - xi)/h,2)), 0);
    }

    function draw() {
      UI.nBadge.textContent = state.n; UI.binsBadge.textContent = state.bins;
      const xs = sample();

      const hist = { x: xs, type: 'histogram', name: '直方图', nbinsx: state.bins, histnorm: 'probability density', marker:{color:'rgba(55,126,184,0.75)'} };
      const traces = [hist];

      if (state.showKDE) {
        const xmin = Math.min(...xs), xmax = Math.max(...xs);
        const X=[]; const Y=[]; const N=256; const pad=(xmax-xmin)*0.05; const lo=xmin-pad, hi=xmax+pad;
        for (let i=0;i<N;i++){ const x=lo + (hi-lo)*i/(N-1); X.push(x); Y.push(kde(x,xs)); }
        traces.push({ x:X, y:Y, mode:'lines', type:'scatter', name:'KDE', line:{width:2, color:'#e41a1c'} });
      }

      if (state.showRug) {
        // rug 以 y≈0 附近短线模拟
        const y0 = -0.01;
        traces.push({ x: xs, y: xs.map(()=>y0), mode:'markers', type:'scatter', name:'rug', marker:{ symbol:'line-ns-open', color:'rgba(0,0,0,0.35)', size:10 }, hoverinfo:'skip', showlegend:false });
      }

      const layout = {
        title: '直方图与核密度估计',
        xaxis: { title: '数值（示例缩放）', range: [-5,105], zeroline:false },
        yaxis: { title: '概率密度', rangemode:'tozero', zeroline:false },
        margin: { l: 60, r: 20, t: 40, b: 40 }
      };
      Plotly.react('plot', traces, layout, {displayModeBar:false});

      UI.stats.textContent = `N=${state.n} ｜ bins=${state.bins} ｜ 均值=${mean(xs).toFixed(2)} ｜ 中位数=${median(xs).toFixed(2)} ｜ 标准差=${std(xs).toFixed(2)} ｜ 偏度≈${skewness(xs).toFixed(2)}`;
    }

    function init(){
      applyScaleFromQuery();
      UI.dist.value = state.dist; UI.n.value = state.n; UI.bins.value = state.bins;
      UI.showKDE.checked = state.showKDE; UI.showRug.checked = state.showRug;
      UI.dist.addEventListener('change', ()=>{ state.dist = UI.dist.value; draw(); });
      UI.n.addEventListener('input', ()=>{ state.n = parseInt(UI.n.value,10)||100; draw(); });
      UI.bins.addEventListener('input', ()=>{ state.bins = parseInt(UI.bins.value,10)||20; draw(); });
      UI.showKDE.addEventListener('change', ()=>{ state.showKDE = UI.showKDE.checked; draw(); });
      UI.showRug.addEventListener('change', ()=>{ state.showRug = UI.showRug.checked; draw(); });
      draw();
      window.addEventListener('resize', ()=>{ Plotly.Plots.resize('plot'); });
    }

    init();
  </script>
</body>
</html>


