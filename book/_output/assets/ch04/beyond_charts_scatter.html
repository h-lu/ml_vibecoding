<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>散点图：趋势、分布与异常</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; margin: 0; }
    .wrap { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    .sub { color:#555; margin-bottom: 14px; font-size: 14px; }
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: center; }
    .ctrl { background: #f7f7f9; border: 1px solid #e3e3e7; border-radius: 10px; padding: 10px 12px; }
    .ctrl label { display: block; font-size: 13px; color: #333; margin-bottom: 6px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input[type=range] { width: 240px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef; border: 1px solid #ccf; font-size: 12px; }
    #plot { width: 100%; height: 520px; }
    .stats { font-size: 13px; color: #333; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>散点图：趋势、分布与异常</h1>
    <div class="sub">通过控制样本量、相关强度与噪声，观察整体趋势、数据分布与异常点；可选择是否显示红色趋势线与自动离群点标注。</div>

    <div class="controls">
      <div class="ctrl">
        <label>样本量 N：<span id="nBadge" class="badge"></span></label>
        <div class="row"><input id="n" type="range" min="50" max="3000" step="50"></div>
      </div>
      <div class="ctrl">
        <label>相关强度 ρ（-0.95 ~ 0.95）：<span id="rhoBadge" class="badge"></span></label>
        <div class="row"><input id="rho" type="range" min="-0.95" max="0.95" step="0.05"></div>
      </div>
      <div class="ctrl">
        <label>噪声 σ：<span id="noiseBadge" class="badge"></span></label>
        <div class="row"><input id="noise" type="range" min="0" max="1.5" step="0.05"></div>
      </div>
      <div class="ctrl">
        <label>可视化选项</label>
        <div class="row">
          <label><input id="showTrend" type="checkbox" checked> 显示趋势线</label>
          <label><input id="showOutliers" type="checkbox" checked> 显示异常点</label>
        </div>
      </div>
      <div class="ctrl">
        <label>当前统计</label>
        <div class="row"><div id="stats" class="stats"></div></div>
      </div>
    </div>

    <div id="plot"></div>
  </div>

  <script>
    function applyScaleFromQuery() {
      const s = parseFloat(new URLSearchParams(location.search).get('scale'));
      if (Number.isFinite(s) && s > 0 && s !== 1) {
        const b = document.body;
        b.style.transform = `scale(${s})`;
        b.style.transformOrigin = 'top left';
        b.style.width = `${100 / s}%`;
        b.style.minWidth = `${100 / s}%`;
      }
    }
    const UI = {
      n: document.getElementById('n'), nBadge: document.getElementById('nBadge'),
      rho: document.getElementById('rho'), rhoBadge: document.getElementById('rhoBadge'),
      noise: document.getElementById('noise'), noiseBadge: document.getElementById('noiseBadge'),
      showTrend: document.getElementById('showTrend'),
      showOutliers: document.getElementById('showOutliers'),
      stats: document.getElementById('stats')
    };

    const state = { n: 600, rho: 0.6, noise: 0.4, showTrend: true, showOutliers: true };

    function randn() { // Box-Muller
      let u=0, v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random();
      return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
    }

    function generateData() {
      // 生成相关二维高斯 + 噪声
      const n = state.n;
      const rho = state.rho;
      const s = Math.sqrt(Math.max(0, 1 - rho*rho));
      const xs = new Array(n), ys = new Array(n);
      for (let i=0;i<n;i++) {
        const z1 = randn();
        const z2 = randn();
        const x = z1;
        const y = rho*z1 + s*z2;
        xs[i] = x + state.noise * randn();
        ys[i] = y + state.noise * randn();
      }
      // 线性缩放到可视化范围 [0, 100]
      function scale(arr) {
        const min = Math.min(...arr), max = Math.max(...arr);
        const a = 100/(max-min || 1);
        const b = -a*min;
        return { vals: arr.map(v=>a*v+b), a, b };
      }
      const sx = scale(xs), sy = scale(ys);
      return { xs:sx.vals, ys:sy.vals, ax:sx.a, bx:sx.b, ay:sy.a, by:sy.b };
    }

    function fitOLS(x, y) {
      const n=x.length; const mean=(a)=>a.reduce((s,v)=>s+v,0)/n;
      const mx=mean(x), my=mean(y);
      let num=0, den=0; for(let i=0;i<n;i++){ num+=(x[i]-mx)*(y[i]-my); den+=(x[i]-mx)*(x[i]-mx); }
      const slope = den===0?0:num/den; const intercept = my - slope*mx;
      return { slope, intercept };
    }

    function detectOutliers(x, y) {
      const n=x.length; const med = (arr)=>{ const b=[...arr].sort((a,b)=>a-b); const m=Math.floor(n/2); return n%2?b[m]:(b[m-1]+b[m])/2; };
      const mx=med(x), my=med(y);
      const dx=x.map(v=>Math.abs(v-mx)); const dy=y.map(v=>Math.abs(v-my));
      const mdx=med(dx)*1.4826 + 1e-9; const mdy=med(dy)*1.4826 + 1e-9; // MAD 标准化
      const score=x.map((_,i)=>Math.hypot(dx[i]/mdx, dy[i]/mdy));
      const thr = 3.5; // Tukey-like threshold
      const idx = []; for(let i=0;i<n;i++){ if(score[i]>thr) idx.push(i); }
      return new Set(idx);
    }

    function draw() {
      UI.nBadge.textContent = state.n;
      UI.rhoBadge.textContent = state.rho.toFixed(2);
      UI.noiseBadge.textContent = state.noise.toFixed(2);

      const { xs, ys } = generateData();
      const outIdx = state.showOutliers ? detectOutliers(xs, ys) : new Set();

      const inliersX = [], inliersY = [], outliersX = [], outliersY = [];
      for (let i=0;i<xs.length;i++) {
        if (outIdx.has(i)) { outliersX.push(xs[i]); outliersY.push(ys[i]); }
        else { inliersX.push(xs[i]); inliersY.push(ys[i]); }
      }

      const inTrace = { x: inliersX, y: inliersY, mode:'markers', type:'scattergl', name:'样本', marker:{ size:6, color:'rgba(55,126,184,0.85)', line:{width:0.5, color:'#333'} } };
      const traces = [inTrace];

      if (outliersX.length>0) {
        traces.push({ x: outliersX, y: outliersY, mode:'markers', type:'scattergl', name:'异常点', marker:{ size:7, color:'rgba(228,26,28,0.9)', symbol:'x' } });
      }

      if (state.showTrend) {
        const fit = fitOLS(xs, ys);
        const x0 = 0, x1 = 100;
        traces.push({ x:[x0,x1], y:[fit.intercept + fit.slope*x0, fit.intercept + fit.slope*x1], mode:'lines', type:'scatter', name:'趋势线', line:{ width:2, color:'#e41a1c' } });
      }

      const layout = {
        title: '散点：观察趋势、分布与异常',
        xaxis: { title: '年龄（示例缩放）', range:[-5,105], zeroline:false },
        yaxis: { title: '上季度消费额（示例缩放）', range:[-5,105], scaleanchor:'x', scaleratio:1, zeroline:false },
        margin: { l: 60, r: 20, t: 40, b: 40 }
      };
      Plotly.react('plot', traces, layout, {displayModeBar:false});

      UI.stats.textContent = `N=${state.n} ｜ ρ≈${state.rho.toFixed(2)} ｜ 噪声σ=${state.noise.toFixed(2)} ｜ 异常点=${state.showOutliers?outIdx.size:0}`;
    }

    function init() {
      applyScaleFromQuery();
      UI.n.value = state.n; UI.rho.value = state.rho; UI.noise.value = state.noise;
      UI.showTrend.checked = state.showTrend; UI.showOutliers.checked = state.showOutliers;
      UI.n.addEventListener('input', ()=>{ state.n = parseInt(UI.n.value,10)||100; draw(); });
      UI.rho.addEventListener('input', ()=>{ state.rho = parseFloat(UI.rho.value)||0; draw(); });
      UI.noise.addEventListener('input', ()=>{ state.noise = parseFloat(UI.noise.value)||0; draw(); });
      UI.showTrend.addEventListener('change', ()=>{ state.showTrend = UI.showTrend.checked; draw(); });
      UI.showOutliers.addEventListener('change', ()=>{ state.showOutliers = UI.showOutliers.checked; draw(); });
      draw();
      window.addEventListener('resize', ()=>{ Plotly.Plots.resize('plot'); });
    }

    init();
  </script>
</body>
</html>


