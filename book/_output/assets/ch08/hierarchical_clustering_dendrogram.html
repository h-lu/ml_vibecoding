<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>层次聚类（Agglomerative）交互树状图</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; margin: 0; }
  .wrap { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
  h1 { font-size: 20px; margin: 0 0 8px; }
  .sub { color:#555; margin-bottom: 14px; font-size: 14px; }
  .grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
  .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  #scatter, #dendro { width: 100%; height: 520px; }
  .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: center; }
  .ctrl { background: #f7f7f9; border: 1px solid #e3e3e7; border-radius: 10px; padding: 10px 12px; }
  .ctrl label { display: block; font-size: 13px; color: #333; margin-bottom: 6px; }
  .row { display: flex; gap: 8px; align-items: center; }
  input[type=range] { width: 100%; }
  select { padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef; border: 1px solid #ccf; font-size: 12px; }
  .stats { font-size: 13px; color: #333; }
</style>
</head>
<body>
<div class="wrap">
  <h1>层次聚类：树状图（Dendrogram）交互演示</h1>
  <div class="sub">选择链接（linkage）方法并拖动“切割高度”，左侧展示散点按簇着色，右侧绘制树状图并显示切割水平。</div>

  <div class="controls">
    <div class="ctrl">
      <label>Linkage 方法：<span id="linkBadge" class="badge"></span></label>
      <div class="row">
        <select id="linkage">
          <option value="single">Single</option>
          <option value="complete">Complete</option>
          <option value="average" selected>Average</option>
          <option value="ward">Ward</option>
        </select>
      </div>
    </div>
    <div class="ctrl">
      <label>切割高度（在树上水平切割）：<span id="hVal" class="badge"></span></label>
      <div class="row">
        <input id="height" type="range" min="0" max="1" step="0.005">
      </div>
    </div>
  </div>

  <div class="row2">
    <div id="scatter"></div>
    <div id="dendro"></div>
  </div>

  <div id="stats" class="stats"></div>
</div>

<script>
const DATA = {"X": [[0.12248632800744583, 0.2578932546182958], [0.24748992466347766, 0.0963680829730263], [0.1687965691622339, 0.3000926798127194], [0.0, 0.16587660458992404], [0.3372695814852976, 0.13762965146676762], [0.1596368330928284, 0.18743813103632959], [0.35786164227000683, 0.15232890343969993], [0.18109209656985642, 0.16552572415364403], [0.4231250742778146, 0.334631360578954], [0.3133502337535365, 0.2184636386564423], [0.2889922016534608, 0.2897246469774709], [0.13616819714823694, 0.26940832546981314], [0.10711900130117123, 0.15240312887397353], [0.304495304731817, 0.10137543869509875], [0.20885038632988812, 0.1379512970413106], [0.1982964254696176, 0.012994251260598427], [0.05983857890085685, 0.148395017122715], [0.30635465793226396, 0.18234608498127639], [0.221903670505638, 0.23794985232917965], [0.14131020091691485, 0.21184692411659942], [0.14808459316092012, 0.08208583908899307], [0.18594042152115559, 0.230568120155165], [0.25256918295836767, 0.1927851293884632], [0.4401533611872969, 0.22018788131024378], [0.31103779293364686, 0.3379447315159969], [0.10344685961814488, 0.126529792890003], [0.38090783738975054, 0.142060468694125], [0.2243548896463614, 0.2625365141564096], [0.30299749973970896, 0.30676685045039415], [0.35825023326003785, 0.26254146256166044], [0.7678174499789995, 0.39437469257487134], [0.8560669795882598, 0.20278892619892655], [0.9456192758697803, 0.39549233215548346], [0.8342451778985113, 0.3015271686852788], [0.7332645536025378, 0.340602174385941], [0.868583463227288, 0.24750858206834897], [0.9249086842806908, 0.2234784345112098], [0.6581821770735494, 0.41649147917740525], [0.7978035547662593, 0.31119732777817927], [0.7625558328906291, 0.1775259441932668], [0.9324618516536196, 0.2603602208138264], [0.9654009531727727, 0.3954988039158078], [0.8049974310433522, 0.22449913796273466], [0.771084991660229, 0.21306242686882335], [1.0, 0.3374334014401132], [0.9239345524025636, 0.20811013750875362], [0.8452497768907202, 0.4289681751181942], [0.8033531665667739, 0.4157135640316412], [0.7424983000760892, 0.19942837661509558], [0.861354626202848, 0.28833245107086625], [0.8826789225547739, 0.1439327029594433], [0.8883791108617289, 0.5572661611727123], [0.8285526118343272, 0.325664450353147], [0.8451291607034387, 0.1544021938639676], [0.8651498315037814, 0.17757589408888058], [0.7958295912747629, 0.4348398302867892], [0.7708613218656492, 0.36785474744479735], [0.9127739560300365, 0.3477572386151226], [0.7192477038722738, 0.29255062029084006], [0.9896321591935494, 0.13967328592280906], [0.40782030022744237, 0.7959658267235014], [0.43196554290025996, 0.8966360477822373], [0.5225676498389225, 0.8177884599734845], [0.47407726698574953, 0.8773992370218198], [0.4534965330519832, 0.7950510504624667], [0.3638854143692742, 0.7535450493454945], [0.3785530545645467, 0.8636144445831917], [0.4709479697847531, 0.8637524269308564], [0.39118681067337524, 0.9785267181883207], [0.517098110918674, 0.8113032170774058], [0.3744737229666868, 0.848790835160617], [0.5017799911862821, 0.8644721272712864], [0.45850184417152884, 0.8222905711786612], [0.4523958460620235, 0.9582873123707978], [0.4100195081412082, 0.8498044696135127], [0.44006823039953774, 0.860675511414532], [0.33864206479289655, 0.6934037169646018], [0.36252550301023184, 0.851711661579484], [0.45833789326830515, 0.7976251953723645], [0.5084754750402439, 0.8276250858586177], [0.8812942905242788, 1.0], [0.018674333659389575, 0.7741935483870968], [0.7798095897166447, 0.0]], "methods": {"single": {"merges": [[64, 78, 0.005483155183043615], [62, 69, 0.008483762810289527], [70, 77, 0.012300048255880113], [63, 67, 0.014000997344153141], [66, 85, 0.015374665609317892], [36, 45, 0.015399139121122557], [79, 84, 0.017185709160828462], [0, 11, 0.017882684359491332], [32, 41, 0.01978167836164077], [47, 55, 0.020552816012346573], [10, 28, 0.022058673434664732], [72, 83, 0.024665920691604313], [18, 27, 0.024708549432988083], [33, 52, 0.024799469242487986], [6, 26, 0.025230296502844137], [4, 97, 0.02530021691458224], [12, 25, 0.02613262595836179], [30, 56, 0.026694056375239635], [31, 54, 0.026799163925419457], [39, 48, 0.02969884119960107], [49, 96, 0.030150004316576686], [5, 19, 0.030523017979004925], [71, 86, 0.030570428433914842], [53, 101, 0.03062429821905848], [7, 104, 0.030667277451072478], [75, 105, 0.031032655600083916], [43, 102, 0.0316715370963884], [74, 108, 0.031954737664354846], [24, 93, 0.032197928231259776], [38, 103, 0.03398237993687957], [87, 110, 0.03436354331781506], [42, 109, 0.035788991401820715], [21, 95, 0.03671301196318219], [9, 17, 0.03678879944425564], [61, 113, 0.03686209056149697], [89, 117, 0.03745042008984126], [40, 88, 0.037647264153393076], [50, 106, 0.037935910987424964], [14, 107, 0.03912635532445195], [92, 100, 0.04145038707244089], [35, 112, 0.04145894794927393], [94, 118, 0.04258170679536358], [46, 122, 0.04394326651140511], [2, 90, 0.04478995715252262], [60, 124, 0.045685392201987404], [34, 125, 0.046435113030533236], [120, 123, 0.04643823837922392], [16, 99, 0.04745000845271501], [115, 121, 0.04839772486695628], [13, 98, 0.04887249901946059], [126, 131, 0.04974537912191743], [58, 128, 0.050054209886034706], [116, 132, 0.054362596742129586], [22, 133, 0.05459144486364321], [135, 136, 0.0547891500783033], [114, 129, 0.055492630892849816], [1, 137, 0.056764228303410345], [57, 91, 0.05794354313193206], [65, 127, 0.06107206029539765], [119, 138, 0.061237068172248256], [3, 130, 0.06233988631083434], [134, 142, 0.06273712710150188], [29, 139, 0.06291950822998574], [20, 143, 0.06299041423345386], [145, 146, 0.0631314029038884], [68, 73, 0.06446843848779939], [141, 148, 0.06494825411548998], [76, 149, 0.06522427890275383], [44, 140, 0.06759204839340988], [111, 147, 0.07012258316547376], [144, 151, 0.07858277708605878], [15, 152, 0.08541004397871205], [23, 154, 0.09220600961482564], [59, 153, 0.09486716077262766], [8, 155, 0.09698297991516651], [37, 156, 0.10675462447581628], [51, 158, 0.13535328837685526], [82, 159, 0.1676504811323399], [157, 160, 0.2489034362793675], [81, 150, 0.3300096147508423], [161, 162, 0.3565292220295987], [80, 163, 0.40235040456825094]], "order": [80, 8, 23, 15, 24, 10, 28, 29, 1, 9, 17, 13, 4, 6, 26, 22, 2, 0, 11, 21, 18, 27, 14, 7, 5, 19, 20, 3, 16, 12, 25, 82, 51, 37, 59, 58, 34, 46, 47, 55, 30, 56, 40, 36, 45, 42, 43, 39, 48, 50, 53, 31, 54, 35, 38, 49, 33, 52, 44, 57, 32, 41, 81, 76, 65, 60, 72, 64, 78, 79, 62, 69, 61, 66, 70, 77, 74, 75, 71, 63, 67, 68, 73], "n_leaves": 83}, "complete": {"merges": [[64, 78, 0.005483155183043615], [62, 69, 0.008483762810289527], [70, 77, 0.012300048255880113], [63, 67, 0.014000997344153141], [36, 45, 0.015399139121122557], [0, 11, 0.017882684359491332], [79, 84, 0.018459502972807483], [32, 41, 0.01978167836164077], [66, 85, 0.01996393378218766], [47, 55, 0.020552816012346573], [10, 28, 0.022058673434664732], [18, 27, 0.024708549432988083], [33, 52, 0.024799469242487986], [6, 26, 0.025230296502844137], [12, 25, 0.02613262595836179], [30, 56, 0.026694056375239635], [31, 54, 0.026799163925419457], [72, 83, 0.027695570552914005], [39, 48, 0.02969884119960107], [5, 19, 0.030523017979004925], [71, 86, 0.030840420105510212], [74, 75, 0.031954737664354846], [42, 43, 0.035788991401820715], [9, 17, 0.03678879944425564], [38, 95, 0.037702836410475636], [50, 53, 0.03898198115657931], [7, 14, 0.03912635532445195], [35, 49, 0.04145894794927393], [4, 96, 0.043862620985125444], [16, 97, 0.048782888166493094], [46, 92, 0.0497677715066142], [21, 94, 0.04997649023652287], [34, 58, 0.050054209886034706], [61, 104, 0.051718711849956814], [40, 87, 0.052941345259674956], [24, 93, 0.05302060587918258], [60, 100, 0.05711051625739202], [1, 13, 0.05722488067321061], [2, 88, 0.06265325149227596], [68, 73, 0.06446843848779939], [99, 108, 0.06459296031665436], [65, 76, 0.06522427890275383], [22, 106, 0.06598273997031785], [101, 105, 0.0673400656831679], [57, 90, 0.07105531567462883], [89, 103, 0.07886365997842991], [91, 116, 0.08270501566182566], [15, 20, 0.08541004397871205], [44, 127, 0.08783486984487486], [29, 118, 0.0889644169911377], [107, 110, 0.0952158168155009], [98, 113, 0.09627301430311887], [102, 114, 0.09913724825370442], [119, 129, 0.11002436072860962], [3, 112, 0.11067711757994612], [121, 135, 0.11302631607228984], [8, 23, 0.11570338155040824], [59, 117, 0.1335431777276504], [111, 125, 0.1379992805191884], [37, 115, 0.13816777867775537], [109, 120, 0.13908131042335278], [123, 140, 0.14772691444167352], [130, 143, 0.15759568314861347], [126, 133, 0.16217457210741829], [128, 136, 0.1635978984239634], [132, 139, 0.17474983758459733], [134, 142, 0.1874832121629989], [122, 147, 0.20932595360646017], [141, 148, 0.2218325164774478], [137, 138, 0.24429133145822463], [51, 131, 0.24654749064565404], [144, 146, 0.25732996407516273], [124, 150, 0.28992425932726795], [145, 152, 0.311251973496577], [82, 154, 0.3292919926584645], [149, 153, 0.35084127996245545], [151, 156, 0.4555359438634049], [81, 155, 0.5057756324761323], [157, 158, 0.5677437056540955], [80, 160, 0.8916847781428109], [159, 161, 1.014609153588463], [162, 163, 1.2134419909007295]], "order": [80, 81, 65, 76, 68, 73, 79, 62, 69, 71, 63, 67, 60, 72, 64, 78, 66, 70, 77, 61, 74, 75, 4, 6, 26, 22, 9, 17, 29, 24, 10, 28, 8, 23, 15, 20, 7, 14, 1, 13, 3, 16, 12, 25, 2, 0, 11, 5, 19, 21, 18, 27, 82, 31, 54, 50, 53, 59, 40, 36, 45, 39, 48, 42, 43, 38, 33, 52, 35, 49, 30, 56, 46, 47, 55, 37, 34, 58, 51, 44, 57, 32, 41], "n_leaves": 83}, "average": {"merges": [[64, 78, 0.005483155183043615], [62, 69, 0.008483762810289527], [70, 77, 0.012300048255880113], [63, 67, 0.014000997344153141], [36, 45, 0.015399139121122557], [66, 85, 0.017669299695752778], [79, 84, 0.017822606066817973], [0, 11, 0.017882684359491332], [32, 41, 0.01978167836164077], [47, 55, 0.020552816012346573], [10, 28, 0.022058673434664732], [18, 27, 0.024708549432988083], [33, 52, 0.024799469242487986], [6, 26, 0.025230296502844137], [12, 25, 0.02613262595836179], [72, 83, 0.02618074562225916], [30, 56, 0.026694056375239635], [31, 54, 0.026799163925419457], [39, 48, 0.02969884119960107], [5, 19, 0.030523017979004925], [71, 86, 0.030705424269712525], [74, 75, 0.031954737664354846], [43, 101, 0.03410861828672139], [4, 96, 0.034581418949853844], [38, 95, 0.0358426081736776], [9, 17, 0.03678879944425564], [50, 53, 0.03898198115657931], [7, 14, 0.03912635532445195], [35, 49, 0.04145894794927393], [24, 93, 0.04260926705522118], [21, 94, 0.04334475109985253], [61, 104, 0.04429040120572689], [40, 87, 0.04529430470653402], [100, 109, 0.04569018676231976], [46, 92, 0.04685551900900965], [16, 97, 0.04811644830960406], [34, 58, 0.050054209886034706], [60, 98, 0.05111358235924318], [2, 90, 0.053721604322399294], [42, 105, 0.055478669734830954], [1, 13, 0.05722488067321061], [103, 114, 0.058900277081986814], [22, 108, 0.06038594502431058], [68, 73, 0.06446843848779939], [57, 91, 0.06449942940328045], [65, 76, 0.06522427890275383], [102, 110, 0.06540745454951616], [107, 111, 0.06573676410494396], [99, 117, 0.06684669508513826], [89, 120, 0.0745928450559123], [29, 112, 0.07804618409989857], [44, 127, 0.07832543009439764], [124, 132, 0.07898864368090752], [113, 121, 0.08175381494562783], [20, 118, 0.08491758545908845], [106, 125, 0.0907329508342199], [115, 116, 0.0929245550032577], [129, 136, 0.09738519347242636], [123, 138, 0.10131875342937076], [88, 135, 0.1023460540056601], [3, 137, 0.11278171156607267], [8, 23, 0.11570338155040824], [119, 131, 0.116939504469039], [122, 130, 0.12005282568828297], [59, 139, 0.12349150282984898], [133, 144, 0.13367838603713428], [37, 145, 0.1358593301096034], [146, 147, 0.13723816977537512], [126, 142, 0.14222735339536552], [140, 143, 0.14654563144402838], [141, 148, 0.16486015900341547], [128, 151, 0.170408726863642], [134, 150, 0.19408035735506607], [15, 152, 0.20081559182906433], [149, 155, 0.2046939868715384], [153, 156, 0.21493440925671642], [51, 157, 0.2878048684384318], [82, 159, 0.316505810319567], [81, 154, 0.42720521652624877], [80, 161, 0.4961258493277044], [158, 160, 0.630352507932448], [162, 163, 0.7031233508893354]], "order": [80, 81, 65, 76, 68, 73, 66, 70, 77, 71, 63, 67, 61, 74, 75, 79, 62, 69, 60, 72, 64, 78, 1, 13, 4, 6, 26, 22, 9, 17, 29, 24, 10, 28, 8, 23, 15, 5, 19, 7, 14, 21, 18, 27, 2, 0, 11, 3, 20, 16, 12, 25, 82, 51, 37, 34, 58, 30, 56, 46, 47, 55, 44, 57, 32, 41, 42, 43, 39, 48, 38, 33, 52, 35, 49, 59, 40, 36, 45, 31, 54, 50, 53], "n_leaves": 83}, "ward": {"merges": [[64, 78, 0.003877176212228305], [62, 69, 0.005998926213133966], [70, 77, 0.008697447530654595], [63, 67, 0.009900200165425529], [36, 45, 0.010888835696980813], [0, 11, 0.012644967376414934], [66, 85, 0.013653978676676691], [32, 41, 0.013987758912767382], [79, 84, 0.014143487708164997], [47, 55, 0.014533035574809719], [10, 28, 0.015597837569630983], [18, 27, 0.017471582857348896], [33, 52, 0.017535872871190468], [6, 26, 0.017840513748508324], [12, 25, 0.018478557025369224], [30, 56, 0.018875548280307936], [31, 54, 0.018949870541793992], [39, 48, 0.021000252005620335], [72, 83, 0.02129491157088384], [5, 19, 0.021583032995233294], [74, 75, 0.022595411693502494], [71, 86, 0.02441084897883164], [43, 100, 0.025150638348529143], [9, 17, 0.026013609558745054], [4, 96, 0.0273602300477595], [38, 95, 0.02750029807241475], [50, 53, 0.027564423219903444], [7, 14, 0.027666511173034355], [35, 49, 0.029315903235791706], [61, 103, 0.034268966750224554], [21, 94, 0.03435228578628993], [24, 93, 0.034663134563646426], [34, 58, 0.035393671237349864], [40, 87, 0.03697537826402691], [46, 92, 0.03740157139928857], [16, 97, 0.037814531643657286], [1, 13, 0.04046410117661823], [99, 109, 0.04114715425258244], [60, 101, 0.04311334214775592], [2, 88, 0.04386218942828625], [68, 73, 0.045586070027230766], [65, 76, 0.046120529910139894], [42, 105, 0.046770026044455196], [22, 106, 0.04718356019497537], [57, 90, 0.052315245314348925], [15, 20, 0.06039402127878854], [44, 127, 0.06260832546019776], [23, 29, 0.0651994946647952], [102, 110, 0.06538227835970771], [104, 112, 0.06726245938331438], [108, 111, 0.06943829988748346], [98, 117, 0.07038292318989642], [8, 130, 0.07861720929262302], [3, 118, 0.0806540527430467], [113, 122, 0.09237879382217172], [59, 116, 0.09560366664617793], [91, 121, 0.09599046635609589], [37, 115, 0.09871537021163448], [107, 119, 0.10319466427344608], [126, 141, 0.1094220706758096], [132, 139, 0.11240825094542145], [120, 138, 0.1260023867934625], [131, 137, 0.13035024537650272], [89, 123, 0.136038501057603], [114, 135, 0.13853379643515942], [134, 140, 0.15048849756063948], [128, 136, 0.16853058537515725], [125, 133, 0.16944750972461592], [51, 129, 0.17886904027750541], [143, 146, 0.1849021428398308], [82, 144, 0.2122755535228596], [124, 152, 0.21634810084442976], [150, 153, 0.2512267061448566], [145, 149, 0.257141736064744], [142, 147, 0.2687161536070132], [148, 151, 0.31897141880863106], [81, 154, 0.4123642513263063], [80, 159, 0.4813156763162753], [156, 157, 0.5042898084641313], [155, 158, 0.5054281431945259], [161, 162, 2.4006028294979695], [160, 163, 2.457786809822306]], "order": [80, 81, 65, 76, 71, 63, 67, 61, 74, 75, 79, 62, 69, 60, 72, 64, 78, 66, 70, 77, 68, 73, 5, 19, 7, 14, 21, 18, 27, 2, 0, 11, 15, 20, 3, 16, 12, 25, 22, 9, 17, 4, 6, 26, 1, 13, 24, 10, 28, 8, 23, 29, 42, 43, 39, 48, 38, 33, 52, 35, 49, 82, 31, 54, 50, 53, 59, 40, 36, 45, 30, 56, 46, 47, 55, 37, 34, 58, 51, 44, 57, 32, 41], "n_leaves": 83}}};

function palette(k) {
  const base = ["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd",
                "#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];
  const out = [];
  for (let i=0;i<k;i++) out.push(base[i % base.length]);
  return out;
}

function buildDendro(methodObj) {
  const n = methodObj.n_leaves;
  const merges = methodObj.merges;
  const order = methodObj.order;
  const pos = new Map(order.map((id, i) => [id, i]));
  const height = new Map();
  const size   = new Map();
  const xcoord = new Map();
  for (let i=0;i<n;i++) { height.set(i, 0.0); size.set(i, 1); xcoord.set(i, pos.get(i)); }
  let curr = n;
  const segments = [];
  for (const [L, R, H] of merges) {
    const xL = xcoord.get(L), xR = xcoord.get(R);
    const hL = height.get(L),  hR = height.get(R);
    const sizeL = size.get(L), sizeR = size.get(R);
    const xP = (sizeL * xL + sizeR * xR) / (sizeL + sizeR);
    segments.push([xL, hL, xL, H]);
    segments.push([xR, hR, xR, H]);
    segments.push([xL, H, xR, H]);
    height.set(curr, H);
    size.set(curr, sizeL + sizeR);
    xcoord.set(curr, xP);
    curr += 1;
  }
  const maxH = Math.max(...merges.map(m => m[2]), 0);
  return { segments, maxH, order };
}

function clustersAtHeight(methodObj, h) {
  const n = methodObj.n_leaves;
  const merges = methodObj.merges;
  const parent = Array(n + merges.length).fill(0).map((_,i)=>i);
  function find(x) { return parent[x] === x ? x : parent[x] = find(parent[x]); }
  function unite(a,b) { a=find(a); b=find(b); if (a!==b) parent[b]=a; }
  let curr = n;
  for (const [L,R,H] of merges) {
    if (H <= h) { unite(L,R); parent[curr] = find(L); } else { parent[curr] = curr; }
    curr += 1;
  }
  const reps = [];
  for (let i=0;i<n;i++) reps.push(find(i));
  const uniq = [...new Set(reps)];
  const idmap = new Map(uniq.map((v,idx)=>[v, idx]));
  const labels = reps.map(v => idmap.get(v));
  return labels;
}

function drawDendrogram(dendro, cutHeight) {
  const xs = [], ys = [];
  for (const [x1,y1,x2,y2] of dendro.segments) {
    xs.push(x1, x2, NaN);
    ys.push(y1, y2, NaN);
  }
  const trace = {
    x: xs, y: ys, mode:"lines", type:"scatter",
    line: { width: 1.5, color: "#444" },
    hoverinfo: "none",
    name: "dendrogram"
  };
  const layout = {
    title: "Dendrogram（树状图）",
    xaxis: { showticklabels: false, range: [-1, dendro.order.length], zeroline: false },
    yaxis: { title: "高度", range: [0, dendro.maxH*1.05], zeroline: false },
    margin: { l: 60, r: 20, t: 40, b: 20 },
    shapes: [{
      type: "line",
      x0: -1, x1: dendro.order.length, y0: cutHeight, y1: cutHeight,
      line: { color: "rgba(200,0,0,0.7)", width: 1.5, dash: "dash" }
    }]
  };
  Plotly.react("dendro", [trace], layout, {displayModeBar:false});
}

function drawScatter(labels) {
  const X = DATA.X;
  const k = Math.max(...labels) + 1;
  const colors = palette(k);
  const cmap = new Map(colors.map((c,i)=>[i,c]));
  const xs = X.map(p=>p[0]);
  const ys = X.map(p=>p[1]);
  const cols = labels.map(lab => cmap.get(lab));
  const trace = {
    x: xs, y: ys, mode: "markers", type: "scattergl",
    marker: { size: 7, color: cols, line: { width: 0.5, color: "#333" }, opacity: 0.9 },
    hovertemplate: "x=%{x:.3f}<br>y=%{y:.3f}<br>簇=%{customdata}<extra></extra>",
    customdata: labels
  };
  const layout = {
    title: "散点（按簇着色）",
    xaxis: { range: [-0.05, 1.05], zeroline: false },
    yaxis: { range: [-0.05, 1.05], scaleanchor: "x", scaleratio: 1, zeroline: false },
    margin: { l: 60, r: 20, t: 40, b: 40 }
  };
  Plotly.react("scatter", [trace], layout, {displayModeBar:false});
}

const linkageSel = document.getElementById("linkage");
const heightEl = document.getElementById("height");
const linkBadge = document.getElementById("linkBadge");
const hVal = document.getElementById("hVal");
const statsEl = document.getElementById("stats");

let current = "average";
let dendro = null;

function refresh() {
  const methodObj = DATA.methods[current];
  dendro = buildDendro(methodObj);
  heightEl.max = (dendro.maxH || 1).toFixed(3);
  let h = parseFloat(heightEl.value);
  if (!(h>=0) || h > dendro.maxH) h = dendro.maxH * 0.5;
  heightEl.value = h;
  hVal.textContent = h.toFixed(3);
  linkBadge.textContent = current;
  const labels = clustersAtHeight(methodObj, h);
  drawScatter(labels);
  drawDendrogram(dendro, h);
  const k = Math.max(...labels)+1;
  statsEl.textContent = `Linkage = ${current} ｜ 切割高度 = ${h.toFixed(3)} ｜ 簇数 = ${k}`;
}

linkageSel.addEventListener("change", ()=>{
  current = linkageSel.value;
  refresh();
});

heightEl.addEventListener("input", ()=>{
  const h = parseFloat(heightEl.value);
  hVal.textContent = h.toFixed(3);
  const methodObj = DATA.methods[current];
  const labels = clustersAtHeight(methodObj, h);
  drawScatter(labels);
  drawDendrogram(dendro, h);
  const k = Math.max(...labels)+1;
  statsEl.textContent = `Linkage = ${current} ｜ 切割高度 = ${h.toFixed(3)} ｜ 簇数 = ${k}`;
});

(function init() {
  const mobj = DATA.methods[current];
  const d = buildDendro(mobj);
  const h0 = (d.maxH || 1) * 0.5;
  heightEl.value = h0.toFixed(3);
  refresh();
})();
</script>
</body>
</html>
